<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>GutCheck TrueOTD</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<!-- Barcode scanning (PDF417 on window stickers) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
<!-- OCR for VIN text plates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
<style>
:root {
  --bg:     #080a08;
  --s1:     #0e110e;
  --s2:     #141814;
  --s3:     #1c221c;
  --border: #252c25;
  --text:   #edf2ed;
  --muted:  #6b7a6b;
  --dim:    #3d473d;
  --lime:   #b8f000;
  --lime2:  #86b000;
  --amber:  #f0a800;
  --red:    #f03c30;
  --blue:   #48b8f0;
  --safe:   #40d878;
  --font-d: 'Barlow Condensed', sans-serif;
  --font-b: 'Barlow', sans-serif;
  --font-m: 'JetBrains Mono', monospace;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; }
body { background:var(--bg); color:var(--text); font-family:var(--font-b); font-size:14px; line-height:1.5; min-height:100vh; }

/* â”€â”€ TOPBAR â”€â”€ */
.topbar { position:sticky; top:0; z-index:100; background:rgba(8,10,8,.96); backdrop-filter:blur(12px); border-bottom:1px solid var(--border); padding:0 20px; height:56px; display:flex; align-items:center; justify-content:space-between; }
.logo { font-family:var(--font-d); font-size:22px; font-weight:800; letter-spacing:1px; line-height:1; }
.logo .gc{color:var(--text)} .logo .sep{color:var(--muted);margin:0 3px} .logo .otd{color:var(--lime)}
.logo-tag { font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-top:2px; }
.status-pill { font-family:var(--font-d); font-size:11px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; padding:4px 12px; border-radius:20px; border:1px solid var(--border); color:var(--muted); }
.status-pill.live { background:rgba(184,240,0,.1); border-color:var(--lime2); color:var(--lime); }
.status-pill.scanning { background:rgba(72,184,240,.1); border-color:var(--blue); color:var(--blue); }

/* â”€â”€ LAYOUT â”€â”€ */
.wrap { max-width:780px; margin:0 auto; padding:20px 16px 60px; }

/* â”€â”€ INPUT CARD â”€â”€ */
.input-card { background:var(--s1); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:20px; }

/* â”€â”€ TOP TABS (3 modes) â”€â”€ */
.mode-tabs { display:grid; grid-template-columns:1fr 1fr 1fr; background:var(--bg); border-bottom:1px solid var(--border); }
.mtab { padding:12px 8px; text-align:center; cursor:pointer; font-family:var(--font-d); font-size:12px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; color:var(--muted); border-bottom:2px solid transparent; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:6px; }
.mtab.active { color:var(--lime); border-bottom-color:var(--lime); background:rgba(184,240,0,.04); }
.mtab-icon { font-size:15px; }

/* â”€â”€ PANELS â”€â”€ */
.panel { display:none; padding:18px 18px 0; }
.panel.active { display:block; }

/* â”€â”€ CAMERA VIEWPORT â”€â”€ */
.cam-area { position:relative; border-radius:12px; overflow:hidden; background:#000; aspect-ratio:16/7; margin-bottom:12px; border:1px solid var(--border); }
#videoFeed { width:100%; height:100%; object-fit:cover; display:block; }
#snapCanvas { display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
.cam-placeholder { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; color:var(--muted); font-size:12px; text-align:center; padding:16px; }
.cam-placeholder .big { font-size:36px; margin-bottom:4px; }

/* BARCODE OVERLAY */
.bc-overlay { position:absolute; inset:0; pointer-events:none; display:none; align-items:center; justify-content:center; }
.bc-overlay.show { display:flex; }
.bc-box { width:85%; height:45%; border:2px solid var(--lime); border-radius:6px; position:relative; box-shadow:0 0 0 2000px rgba(0,0,0,.5); }
.bc-label { position:absolute; top:-22px; left:50%; transform:translateX(-50%); font-family:var(--font-d); font-size:10px; font-weight:700; letter-spacing:2px; color:var(--lime); white-space:nowrap; }
.bc-scan-line { position:absolute; left:4px; right:4px; height:2px; background:linear-gradient(90deg,transparent,var(--lime),transparent); animation:scanLine 1.8s ease-in-out infinite; }
@keyframes scanLine { 0%{top:8%} 50%{top:85%} 100%{top:8%} }

/* VIN TEXT OVERLAY */
.vin-overlay { position:absolute; inset:0; pointer-events:none; display:none; align-items:center; justify-content:center; }
.vin-overlay.show { display:flex; }
.vin-box { width:80%; height:30%; border:2px solid var(--amber); border-radius:6px; position:relative; box-shadow:0 0 0 2000px rgba(0,0,0,.5); }
.vin-box-label { position:absolute; top:-22px; left:50%; transform:translateX(-50%); font-family:var(--font-d); font-size:10px; font-weight:700; letter-spacing:2px; color:var(--amber); white-space:nowrap; }

/* STATUS BAR */
.scan-status { display:none; align-items:center; gap:10px; background:var(--s2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; margin-bottom:12px; }
.scan-status.show { display:flex; }
.spin { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--lime); border-radius:50%; animation:spin .7s linear infinite; flex-shrink:0; }
@keyframes spin { to{transform:rotate(360deg)} }
.scan-status-text { font-size:12px; color:var(--muted); flex:1; }
.scan-status-text b { color:var(--lime); }
.scan-pct { font-family:var(--font-m); font-size:11px; color:var(--lime); }

/* VIN CONFIRM */
.vin-confirm { display:none; background:rgba(184,240,0,.07); border:1px solid rgba(184,240,0,.25); border-radius:10px; padding:12px 14px; margin-bottom:12px; }
.vin-confirm.show { display:block; }
.vc-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.vc-label { font-size:11px; color:var(--muted); }
.vc-label b { color:var(--lime); }
.vc-source { font-family:var(--font-d); font-size:9px; font-weight:700; letter-spacing:1.5px; padding:2px 8px; border-radius:3px; }
.vc-source.barcode { background:rgba(184,240,0,.15); color:var(--lime); }
.vc-source.ocr     { background:rgba(240,168,0,.15); color:var(--amber); }
.vc-clear { font-size:11px; color:var(--muted); cursor:pointer; margin-left:10px; }
.vc-clear:hover { color:var(--red); }
.vc-field { width:100%; background:var(--bg); border:1px solid var(--lime2); border-radius:6px; color:var(--lime); font-family:var(--font-m); font-size:17px; letter-spacing:3px; padding:9px 12px; text-transform:uppercase; outline:none; transition:border-color .2s; }
.vc-field:focus { border-color:var(--lime); }
.vc-counter { font-size:11px; color:var(--muted); text-align:right; margin-top:4px; font-family:var(--font-m); }
.vc-counter.ready { color:var(--lime); }

/* BUTTONS */
.btn-row { display:flex; gap:8px; margin-bottom:14px; }
.btn { flex:1; padding:11px 10px; border-radius:9px; border:none; cursor:pointer; font-family:var(--font-d); font-size:13px; font-weight:800; letter-spacing:.5px; text-transform:uppercase; transition:all .15s; display:flex; align-items:center; justify-content:center; gap:7px; white-space:nowrap; }
.btn.primary { background:var(--lime); color:#000; }
.btn.primary:hover { background:#ccff00; transform:translateY(-1px); }
.btn.secondary { background:var(--s3); color:var(--text); border:1px solid var(--border); }
.btn.secondary:hover { border-color:var(--lime); }
.btn.amber-btn { background:rgba(240,168,0,.12); color:var(--amber); border:1px solid rgba(240,168,0,.3); }
.btn.amber-btn:hover { background:rgba(240,168,0,.2); }
.btn:disabled { opacity:.4; cursor:not-allowed; transform:none !important; }

/* SCAN MODE SELECTOR (inside barcode/ocr panels) */
.scan-method { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px; }
.sm-btn { padding:14px 10px; border-radius:10px; border:1px solid var(--border); background:var(--s2); cursor:pointer; text-align:center; transition:all .2s; }
.sm-btn.active { border-color:var(--lime); background:rgba(184,240,0,.08); }
.sm-btn.active.amber-mode { border-color:var(--amber); background:rgba(240,168,0,.08); }
.sm-icon { font-size:22px; margin-bottom:5px; }
.sm-title { font-family:var(--font-d); font-size:13px; font-weight:700; margin-bottom:2px; }
.sm-btn.active .sm-title { color:var(--lime); }
.sm-btn.active.amber-mode .sm-title { color:var(--amber); }
.sm-desc { font-size:10px; color:var(--muted); line-height:1.4; }

/* HINT */
.scan-hint { font-size:11px; color:var(--muted); text-align:center; margin-bottom:12px; line-height:1.55; }
.scan-hint b { color:var(--text); }

/* STICKER FIELDS */
.sticker-fields { border-top:1px solid var(--border); padding-top:16px; margin-bottom:16px; }
.field-label { font-family:var(--font-d); font-size:10px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:6px; display:block; }
.fields-row { display:grid; grid-template-columns:1fr 1fr 90px; gap:8px; margin-bottom:10px; }
.nf { width:100%; background:var(--s2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:var(--font-m); font-size:14px; padding:9px 12px; outline:none; transition:border-color .2s; letter-spacing:0; }
.nf:focus { border-color:var(--lime); }
.addon-section { margin-top:4px; }
#addonRows .addon-row { display:flex; gap:8px; margin-bottom:7px; align-items:center; }
.addon-name { flex:1; font-size:13px !important; letter-spacing:0 !important; }
.addon-price { width:90px !important; }
.add-btn { background:none; border:1px dashed var(--border); border-radius:6px; color:var(--muted); cursor:pointer; font-size:12px; padding:6px 14px; font-family:var(--font-b); transition:all .15s; }
.add-btn:hover { border-color:var(--lime); color:var(--lime); }
.del-btn { background:none; border:1px solid var(--border); border-radius:6px; color:var(--muted); cursor:pointer; width:30px; height:30px; font-size:14px; flex-shrink:0; transition:all .15s; }
.del-btn:hover { border-color:var(--red); color:var(--red); }

/* VIN FIELD (manual tab) */
.vin-input { width:100%; background:var(--s2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:var(--font-m); font-size:18px; letter-spacing:3px; padding:12px 16px; text-transform:uppercase; outline:none; transition:border-color .2s; }
.vin-input:focus { border-color:var(--lime); }
.vin-counter { font-size:11px; color:var(--muted); text-align:right; margin-top:4px; font-family:var(--font-m); }
.vin-counter.ready { color:var(--lime); }

/* ERROR */
.err-bar { background:rgba(240,60,48,.1); border:1px solid rgba(240,60,48,.3); border-radius:8px; padding:10px 14px; color:var(--red); font-size:13px; margin-bottom:12px; display:none; }
.err-bar.show { display:block; }

/* ANALYZE BUTTON */
.analyze-btn { width:100%; background:var(--lime); border:none; border-radius:10px; color:#000; cursor:pointer; font-family:var(--font-d); font-size:18px; font-weight:800; letter-spacing:2px; text-transform:uppercase; padding:15px; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:10px; margin-top:2px; }
.analyze-btn:hover { background:#ccff00; transform:translateY(-1px); box-shadow:0 4px 20px rgba(184,240,0,.2); }
.analyze-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; box-shadow:none; }
.shared-bottom { padding:0 18px 18px; }

/* â”€â”€ RESULTS â”€â”€ */
#results { animation:fadeUp .4s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.hero { display:grid; grid-template-columns:2fr 1fr 1fr; gap:2px; background:var(--border); border-radius:14px; overflow:hidden; margin-bottom:14px; }
.hcell { background:var(--s1); padding:20px 18px; }
.hcell.main { background:linear-gradient(135deg,#0a1a02,#0d2004); border:1px solid rgba(184,240,0,.15); }
.hc-l { font-family:var(--font-d); font-size:9px; font-weight:700; letter-spacing:2.5px; text-transform:uppercase; color:var(--muted); margin-bottom:6px; }
.hc-v { font-family:var(--font-d); font-size:36px; font-weight:800; line-height:1; letter-spacing:-1px; }
.hc-v.lime{color:var(--lime)} .hc-v.dim{color:var(--dim)} .hc-v.amber{color:var(--amber)}
.hc-s { font-size:11px; color:var(--muted); margin-top:5px; }
.save-pct { display:inline-block; background:rgba(184,240,0,.12); border:1px solid rgba(184,240,0,.3); border-radius:20px; color:var(--lime); font-family:var(--font-d); font-size:12px; font-weight:700; padding:3px 10px; margin-top:7px; }
.vstrip { background:var(--s1); border:1px solid var(--border); border-radius:10px; padding:13px 16px; margin-bottom:14px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
.vtitle { font-family:var(--font-d); font-size:20px; font-weight:800; }
.vmeta { display:flex; gap:6px; flex-wrap:wrap; margin-top:5px; }
.vchip { font-size:10px; background:var(--s2); border:1px solid var(--border); border-radius:4px; padding:2px 7px; color:var(--muted); }
.vchip b{color:#9aaa9a}
.mkt-tag { font-family:var(--font-d); font-size:10px; font-weight:700; letter-spacing:1px; padding:4px 12px; border-radius:20px; white-space:nowrap; background:rgba(240,168,0,.12); color:var(--amber); border:1px solid rgba(240,168,0,.25); }
.tbl-wrap { background:var(--s1); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:14px; }
table{width:100%;border-collapse:collapse}
thead tr{background:var(--s2)}
th { font-family:var(--font-d); font-size:9px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); padding:10px 13px; text-align:left; border-bottom:1px solid var(--border); }
th:nth-child(n+3){text-align:right}
td { padding:10px 13px; border-bottom:1px solid rgba(37,44,37,.5); vertical-align:middle; font-size:13px; }
tr:last-child td{border-bottom:none}
td:nth-child(n+3){text-align:right;font-family:var(--font-m);font-size:12px}
.row-pay td:first-child{border-left:3px solid var(--safe);padding-left:10px}
.row-neg td:first-child{border-left:3px solid var(--amber);padding-left:10px}
.row-ref td:first-child{border-left:3px solid var(--red);padding-left:10px}
.row-fix td:first-child{border-left:3px solid var(--blue);padding-left:10px}
.row-total td{background:rgba(184,240,0,.05);font-weight:600}
.row-sticker td{color:var(--muted)}
.iname{font-weight:600;color:var(--text)} .inote{font-size:11px;color:var(--muted);margin-top:2px}
.tag { display:inline-block; font-family:var(--font-d); font-size:9px; font-weight:700; letter-spacing:1px; padding:2px 7px; border-radius:3px; }
.t-pay{background:rgba(64,216,120,.15);color:var(--safe)}
.t-neg{background:rgba(240,168,0,.15);color:var(--amber)}
.t-ref{background:rgba(240,60,48,.15);color:var(--red)}
.t-fix{background:rgba(72,184,240,.15);color:var(--blue)}
.strike{text-decoration:line-through;color:var(--muted)}
.lime{color:var(--lime)} .amber{color:var(--amber)} .red{color:var(--red)}
.play { background:var(--s1); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:14px; }
.play-hdr { font-family:var(--font-d); font-size:13px; font-weight:800; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:12px; }
.steps{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.step{display:flex;gap:9px;align-items:flex-start}
.sn{background:var(--lime);color:#000;font-family:var(--font-d);font-size:10px;font-weight:800;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.st{font-size:12px;color:#8a9a8a;line-height:1.55}
.st b{color:var(--text)} .st .m{color:var(--lime);font-family:var(--font-m);font-size:11px}
.foot{font-size:10px;color:var(--dim);margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}

@media(max-width:580px){
  .hero{grid-template-columns:1fr 1fr}
  .hcell.main{grid-column:1/-1}
  .hc-v{font-size:28px}
  .fields-row{grid-template-columns:1fr 1fr}
  .steps{grid-template-columns:1fr}
  th:nth-child(4),td:nth-child(4){display:none}
}
@media(max-width:400px){.fields-row{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="topbar">
  <div>
    <div class="logo"><span class="gc">GutCheck</span><span class="sep">|</span><span class="otd">TrueOTD</span></div>
    <div class="logo-tag">Conflict-Free Car Price Intelligence</div>
  </div>
  <div class="status-pill" id="statusPill">ğŸ“ Ready</div>
</div>

<div class="wrap">
  <div class="input-card">

    <!-- â”€â”€ THREE MODE TABS â”€â”€ -->
    <div class="mode-tabs">
      <div class="mtab active" id="tab-barcode" onclick="switchTab('barcode')">
        <span class="mtab-icon">â–¦</span> Scan Barcode
      </div>
      <div class="mtab" id="tab-photo" onclick="switchTab('photo')">
        <span class="mtab-icon">ğŸ“·</span> Photo VIN
      </div>
      <div class="mtab" id="tab-manual" onclick="switchTab('manual')">
        <span class="mtab-icon">âŒ¨ï¸</span> Enter VIN
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 1 â€” BARCODE SCAN
         Reads PDF417 barcode on window sticker
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel active" id="panel-barcode">
      <div class="scan-method">
        <div class="sm-btn active" id="bc-live-btn" onclick="setBarcodeMode('live')">
          <div class="sm-icon">ğŸ“¹</div>
          <div class="sm-title">Live Camera</div>
          <div class="sm-desc">Hold phone over barcode Â· auto-detects</div>
        </div>
        <div class="sm-btn" id="bc-upload-btn" onclick="setBarcodeMode('upload')">
          <div class="sm-icon">ğŸ–¼</div>
          <div class="sm-title">Upload Photo</div>
          <div class="sm-desc">Photo of sticker barcode from camera roll</div>
        </div>
      </div>

      <!-- Camera view -->
      <div class="cam-area" id="bcCamArea">
        <video id="videoFeed" autoplay playsinline muted></video>
        <canvas id="snapCanvas"></canvas>
        <div class="bc-overlay" id="bcOverlay">
          <div class="bc-box">
            <div class="bc-label">POINT AT WINDOW STICKER BARCODE</div>
            <div class="bc-scan-line"></div>
          </div>
        </div>
        <div class="cam-placeholder" id="bcPlaceholder">
          <div class="big">â–¦</div>
          <div>Tap <b style="color:var(--text)">Start Scanner</b> below</div>
          <div style="font-size:10px;margin-top:4px">Aim at the <b style="color:var(--lime)">PDF417 barcode</b> on the window sticker</div>
        </div>
      </div>

      <div class="scan-status" id="bcStatus">
        <div class="spin"></div>
        <div class="scan-status-text" id="bcStatusText">Scanning for barcodeâ€¦</div>
      </div>

      <div class="scan-hint">
        Find the <b>barcode on the window sticker</b> (lower right, wide rectangular). Hold steady â€” auto-detects in 1â€“3 sec.
      </div>

      <!-- Barcode buttons -->
      <div class="btn-row" id="bcBtnRow">
        <button class="btn primary" id="bcStartBtn" onclick="startBarcodeScanner()">â–¶ Start Scanner</button>
        <button class="btn secondary" id="bcStopBtn" onclick="stopBarcodeScanner()" style="display:none">â¹ Stop</button>
        <label class="btn secondary" id="bcUploadLabel" style="display:none;cursor:pointer">
          ğŸ“ Choose Photo
          <input type="file" accept="image/*" id="bcUploadInput" onchange="decodeBarcodeFromFile(event)" style="display:none">
        </label>
        <button class="btn secondary" id="bcRetakeBtn" onclick="resetBarcodeScanner()" style="display:none">â†º Retry</button>
      </div>

      <!-- VIN confirm (shared, shown after any successful read) -->
      <div class="vin-confirm" id="vinConfirm">
        <div class="vc-top">
          <div>
            <div class="vc-label"><b>âœ“ VIN captured</b> â€” verify before analyzing</div>
            <div style="margin-top:3px"><span class="vc-source barcode" id="vcSource">BARCODE</span></div>
          </div>
          <div class="vc-clear" onclick="clearVin()">âœ• Clear</div>
        </div>
        <input type="text" class="vc-field" id="vinConfirmField" maxlength="17"
          oninput="onConfirmType(this)" placeholder="17-character VIN">
        <div class="vc-counter" id="vcCounter">0 / 17</div>
      </div>

      <!-- Sticker details -->
      <div class="sticker-fields" id="bcStickerFields">
        <div class="field-label">Sticker Prices</div>
        <div class="fields-row">
          <div>
            <div class="field-label">Base MSRP ($)</div>
            <input type="number" class="nf" id="msrpBC" placeholder="e.g. 42,500">
          </div>
          <div>
            <div class="field-label">Doc Fee ($)</div>
            <input type="number" class="nf" id="docBC" placeholder="e.g. 999">
          </div>
          <div>
            <div class="field-label">State</div>
            <input type="text" class="nf" id="stateBC" value="FL" maxlength="2" style="text-transform:uppercase">
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 2 â€” PHOTO OF VIN TEXT
         OCR reads VIN plate or sticker text
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-photo">
      <div class="scan-method">
        <div class="sm-btn active amber-mode" id="ph-cam-btn" onclick="setPhotoMode('camera')">
          <div class="sm-icon">ğŸ“·</div>
          <div class="sm-title">Take Photo</div>
          <div class="sm-desc">Camera captures VIN plate live</div>
        </div>
        <div class="sm-btn" id="ph-upload-btn" onclick="setPhotoMode('upload')">
          <div class="sm-icon">ğŸ–¼</div>
          <div class="sm-title">Upload Photo</div>
          <div class="sm-desc">Use photo already in camera roll</div>
        </div>
      </div>

      <div class="cam-area" id="phCamArea">
        <video id="videoFeedOCR" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;display:block"></video>
        <canvas id="snapCanvasOCR" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover"></canvas>
        <div class="vin-overlay" id="vinOverlay">
          <div class="vin-box">
            <div class="vin-box-label">ALIGN VIN NUMBER HERE</div>
          </div>
        </div>
        <div class="cam-placeholder" id="phPlaceholder">
          <div class="big">ğŸ“·</div>
          <div>Tap <b style="color:var(--text)">Start Camera</b> below</div>
          <div style="font-size:10px;margin-top:4px">Aim at dashboard VIN plate, door jamb sticker, or window label</div>
        </div>
      </div>

      <div class="scan-status" id="phStatus">
        <div class="spin" style="border-top-color:var(--amber)"></div>
        <div class="scan-status-text" id="phStatusText">Reading VIN textâ€¦</div>
        <div class="scan-pct" style="color:var(--amber)" id="phPct"></div>
      </div>

      <div class="scan-hint">
        Point at the <b>VIN plate on the dashboard</b> (visible through windshield), <b>door jamb sticker</b>, or VIN on the window sticker. Fill the frame with the VIN number.
      </div>

      <div class="btn-row" id="phBtnRow">
        <button class="btn amber-btn" id="phStartBtn" onclick="startOCRCamera()">ğŸ“· Start Camera</button>
        <button class="btn amber-btn" id="phCaptureBtn" onclick="captureOCR()" style="display:none">âŠ™ Capture</button>
        <label class="btn secondary" id="phUploadLabel" style="display:none;cursor:pointer">
          ğŸ“ Choose Photo
          <input type="file" accept="image/*" id="phUploadInput" onchange="handleOCRUpload(event)" style="display:none">
        </label>
        <button class="btn secondary" id="phRetakeBtn" onclick="resetOCRCamera()" style="display:none">â†º Retake</button>
      </div>

      <!-- VIN confirm for photo tab (same confirm widget, shown here too) -->
      <div class="vin-confirm" id="vinConfirmPhoto">
        <div class="vc-top">
          <div>
            <div class="vc-label"><b>âœ“ VIN read</b> â€” verify and correct if needed</div>
            <div style="margin-top:3px"><span class="vc-source ocr" id="vcSourcePhoto">OCR TEXT</span></div>
          </div>
          <div class="vc-clear" onclick="clearVinPhoto()">âœ• Clear</div>
        </div>
        <input type="text" class="vc-field" style="border-color:var(--amber);color:var(--amber)" id="vinConfirmPhotoField" maxlength="17"
          oninput="onConfirmTypePhoto(this)" placeholder="17-character VIN">
        <div class="vc-counter" id="vcCounterPhoto">0 / 17</div>
      </div>

      <div class="sticker-fields">
        <div class="field-label">Sticker Prices</div>
        <div class="fields-row">
          <div>
            <div class="field-label">Base MSRP ($)</div>
            <input type="number" class="nf" id="msrpPhoto" placeholder="e.g. 42,500">
          </div>
          <div>
            <div class="field-label">Doc Fee ($)</div>
            <input type="number" class="nf" id="docPhoto" placeholder="e.g. 999">
          </div>
          <div>
            <div class="field-label">State</div>
            <input type="text" class="nf" id="statePhoto" value="FL" maxlength="2" style="text-transform:uppercase">
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 3 â€” MANUAL ENTRY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-manual">
      <div style="margin-bottom:14px">
        <div class="field-label">Vehicle Identification Number (VIN)</div>
        <input type="text" class="vin-input" id="vinManual" maxlength="17"
          placeholder="Enter 17-character VIN"
          oninput="onVinType(this)">
        <div class="vin-counter" id="vinCounter">0 / 17</div>
      </div>
      <div class="fields-row" style="margin-bottom:14px">
        <div>
          <div class="field-label">Base MSRP ($)</div>
          <input type="number" class="nf" id="msrpManual" placeholder="e.g. 42,500">
        </div>
        <div>
          <div class="field-label">Doc Fee ($)</div>
          <input type="number" class="nf" id="docManual" placeholder="e.g. 999">
        </div>
        <div>
          <div class="field-label">State</div>
          <input type="text" class="nf" id="stateManual" value="FL" maxlength="2" style="text-transform:uppercase">
        </div>
      </div>
      <div class="addon-section">
        <div class="field-label" style="margin-bottom:8px">Dealer Add-Ons (from sticker)</div>
        <div id="addonRows"></div>
        <button class="add-btn" onclick="addRow()">+ Add dealer option</button>
      </div>
      <div style="height:16px"></div>
    </div>

    <!-- â”€â”€ SHARED BOTTOM â”€â”€ -->
    <div class="shared-bottom">
      <div class="err-bar" id="errBar"></div>
      <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">
        <span>âš¡</span> Get My TrueOTD Price
      </button>
    </div>
  </div>

  <div id="results"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TAX={AL:.04,AK:0,AZ:.056,AR:.065,CA:.0725,CO:.029,CT:.0635,DE:0,FL:.06,GA:.04,HI:.04,ID:.06,IL:.0625,IN:.07,IA:.06,KS:.065,KY:.06,LA:.0445,ME:.055,MD:.06,MA:.0625,MI:.06,MN:.06875,MS:.07,MO:.04225,MT:0,NE:.055,NV:.0685,NH:0,NJ:.06625,NM:.05125,NY:.04,NC:.03,ND:.05,OH:.0575,OK:.045,OR:0,PA:.06,RI:.07,SC:.06,SD:.045,TN:.07,TX:.0625,UT:.0485,VT:.06,VA:.043,WA:.065,WV:.06,WI:.05,WY:.04,DC:.06};
const REG={FL:225,PA:130,TX:150,CA:200,NY:180,OH:100,GA:120,NC:100,VA:140,NJ:150,TN:110,SC:100};
const ADDON_INTEL={
  'trd front skid plate':{cat:'neg',disc:50,note:'OEM part ~$280 wholesale'},
  'toyoguard':{cat:'neg',disc:55,note:'SET bundle Â· real value ~$300'},
  'ambient lighting':{cat:'neg',disc:45,note:'Dealer-installed Â· target $300'},
  'dashcam':{cat:'ref',disc:100,note:'Buy on Amazon for $60â€“$120'},
  'cargo cross bar':{cat:'neg',disc:40,note:'Marked up 3Ã—'},
  'console safe':{cat:'ref',disc:100,note:'Online cost ~$60'},
  'screen protector':{cat:'ref',disc:100,note:'Dealer cost <$5'},
  'multimedia screen protector':{cat:'ref',disc:100,note:'Dealer cost <$5'},
  'emergency':{cat:'ref',disc:100,note:'Amazon ~$25'},
  'phone cable':{cat:'ref',disc:100,note:'USB cables Â· cost <$5'},
  'cable charge':{cat:'ref',disc:100,note:'USB cables Â· cost <$5'},
  'nitrogen':{cat:'ref',disc:100,note:'Free air works the same'},
  'vin etching':{cat:'ref',disc:100,note:'Insurance benefit is minimal'},
  'paint protection':{cat:'neg',disc:60,note:'Can DIY for $40'},
  'fabric protection':{cat:'ref',disc:100,note:'Scotchguard spray = $10'},
  'lo-jack':{cat:'neg',disc:50,note:'Subscription model â€” negotiate hard'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeTab = 'barcode';
let barcodeStream = null;
let ocrStream = null;
let codeReader = null;
let barcodeScanning = false;
let addonCount = 0;
let detectedVIN_bc = '';   // barcode tab VIN
let detectedVIN_ph = '';   // photo tab VIN

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  // Stop any active scanning
  if (tab !== 'barcode') stopBarcodeScanner();
  if (tab !== 'photo')   stopOCRCamera();

  activeTab = tab;
  ['barcode','photo','manual'].forEach(t => {
    document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    document.getElementById(`panel-${t}`).classList.toggle('active', t === tab);
  });
  hideErr();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 1 â€” BARCODE SCANNER
// Uses ZXing to decode PDF417 barcodes on window stickers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let barcodeMode = 'live';

function setBarcodeMode(mode) {
  barcodeMode = mode;
  document.getElementById('bc-live-btn').classList.toggle('active', mode === 'live');
  document.getElementById('bc-upload-btn').classList.toggle('active', mode === 'upload');
  stopBarcodeScanner();

  if (mode === 'upload') {
    document.getElementById('bcStartBtn').style.display = 'none';
    document.getElementById('bcUploadLabel').style.display = 'flex';
  } else {
    document.getElementById('bcStartBtn').style.display = 'flex';
    document.getElementById('bcUploadLabel').style.display = 'none';
  }
  document.getElementById('bcPlaceholder').style.display = 'flex';
  document.getElementById('snapCanvas').style.display = 'none';
}

async function startBarcodeScanner() {
  setPill('ğŸŸ¢ Scanner Live', 'live');
  document.getElementById('bcStartBtn').style.display = 'none';
  document.getElementById('bcStopBtn').style.display = 'flex';
  document.getElementById('bcPlaceholder').style.display = 'none';
  document.getElementById('bcOverlay').classList.add('show');
  showBcStatus('Scanning for barcodeâ€¦');

  try {
    // Try ZXing if available
    if (typeof ZXing !== 'undefined') {
      codeReader = new ZXing.BrowserMultiFormatReader();
      barcodeStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width:{ideal:1920}, height:{ideal:1080} }
      });
      const video = document.getElementById('videoFeed');
      video.srcObject = barcodeStream;
      video.style.display = 'block';
      barcodeScanning = true;

      codeReader.decodeFromVideoElement(video, (result, err) => {
        if (!barcodeScanning) return;
        if (result) {
          const text = result.getText();
          const vin = extractVINFromBarcode(text);
          if (vin) {
            barcodeScanning = false;
            stopBarcodeScanner();
            showBcVinConfirm(vin, 'BARCODE');
            setPill('âœ“ VIN Found', 'live');
          }
        }
      });
    } else {
      // ZXing not loaded â€” fallback to camera + manual confirm
      barcodeStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width:{ideal:1920}, height:{ideal:1080} }
      });
      const video = document.getElementById('videoFeed');
      video.srcObject = barcodeStream;
      video.style.display = 'block';
      barcodeScanning = true;
      showBcStatus('Camera live â€” position barcode in frame then tap Stop to read');
      document.getElementById('bcStopBtn').textContent = 'âŠ™ Capture';
    }
  } catch(e) {
    showErr('Camera not available. Use "Upload Photo" to scan a barcode from your camera roll.');
    resetBarcodeScanner();
  }
}

function stopBarcodeScanner() {
  barcodeScanning = false;
  if (codeReader) { try { codeReader.reset(); } catch(e){} codeReader = null; }
  if (barcodeStream) { barcodeStream.getTracks().forEach(t => t.stop()); barcodeStream = null; }
  document.getElementById('videoFeed').style.display = 'none';
  document.getElementById('bcOverlay').classList.remove('show');
  document.getElementById('bcStopBtn').style.display = 'none';
  document.getElementById('bcStatus').classList.remove('show');
  setPill('ğŸ“ Ready', '');
}

function resetBarcodeScanner() {
  stopBarcodeScanner();
  document.getElementById('bcPlaceholder').style.display = 'flex';
  document.getElementById('snapCanvas').style.display = 'none';
  document.getElementById('bcStartBtn').style.display = barcodeMode === 'live' ? 'flex' : 'none';
  document.getElementById('bcUploadLabel').style.display = barcodeMode === 'upload' ? 'flex' : 'none';
  document.getElementById('bcRetakeBtn').style.display = 'none';
  document.getElementById('vinConfirm').classList.remove('show');
  detectedVIN_bc = '';
}

async function decodeBarcodeFromFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  showBcStatus('Reading barcode from imageâ€¦');
  document.getElementById('bcPlaceholder').style.display = 'none';

  // Show image preview
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.onload = async () => {
    const canvas = document.getElementById('snapCanvas');
    canvas.width = img.width; canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);
    canvas.style.display = 'block';
    URL.revokeObjectURL(url);

    document.getElementById('bcRetakeBtn').style.display = 'flex';
    document.getElementById('bcUploadLabel').style.display = 'none';

    try {
      if (typeof ZXing !== 'undefined') {
        const reader = new ZXing.BrowserMultiFormatReader();
        const result = await reader.decodeFromCanvas(canvas);
        const vin = extractVINFromBarcode(result.getText());
        hideBcStatus();
        if (vin) {
          showBcVinConfirm(vin, 'BARCODE');
        } else {
          showBcStatus('Barcode read but no VIN found â€” try the Photo VIN tab for text OCR');
        }
      } else {
        // Fallback to OCR on the barcode image
        hideBcStatus();
        showBcStatus('Running text scan on imageâ€¦');
        await runOCROnCanvas(canvas, 'bc');
      }
    } catch(err) {
      hideBcStatus();
      showBcStatus('Could not read barcode â€” try the Photo VIN tab instead, or enter VIN manually');
    }
  };
  img.src = url;
  e.target.value = '';
}

function extractVINFromBarcode(text) {
  if (!text) return null;
  // PDF417 on window stickers often has format: ...VIN17CHARS...
  // Try direct 17-char VIN pattern first
  const clean = text.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
  const match = clean.match(/[A-HJ-NPR-Z0-9]{17}/);
  if (match) return match[0];

  // Also try parsing key=value formats some stickers use
  const vinKV = text.match(/VIN[:\s=]+([A-HJ-NPR-Z0-9]{17})/i);
  if (vinKV) return vinKV[1].toUpperCase();

  return null;
}

function showBcVinConfirm(vin, source) {
  detectedVIN_bc = vin;
  const el = document.getElementById('vinConfirm');
  const field = document.getElementById('vinConfirmField');
  const counter = document.getElementById('vcCounter');
  document.getElementById('vcSource').textContent = source;
  document.getElementById('vcSource').className = 'vc-source ' + (source === 'BARCODE' ? 'barcode' : 'ocr');
  field.value = vin;
  counter.textContent = vin.length + ' / 17';
  counter.className = 'vc-counter' + (vin.length === 17 ? ' ready' : '');
  el.classList.add('show');
  hideBcStatus();
}

function onConfirmType(el) {
  el.value = el.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
  detectedVIN_bc = el.value;
  const counter = document.getElementById('vcCounter');
  counter.textContent = el.value.length + ' / 17';
  counter.className = 'vc-counter' + (el.value.length === 17 ? ' ready' : '');
}

function clearVin() {
  detectedVIN_bc = '';
  document.getElementById('vinConfirm').classList.remove('show');
  document.getElementById('vinConfirmField').value = '';
  resetBarcodeScanner();
}

function showBcStatus(msg) {
  const s = document.getElementById('bcStatus');
  document.getElementById('bcStatusText').innerHTML = msg;
  s.classList.add('show');
}
function hideBcStatus() { document.getElementById('bcStatus').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 2 â€” PHOTO OCR (VIN text plate / door jamb / sticker)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let photoMode = 'camera';

function setPhotoMode(mode) {
  photoMode = mode;
  document.getElementById('ph-cam-btn').classList.toggle('active', mode === 'camera');
  document.getElementById('ph-upload-btn').classList.toggle('active', mode === 'upload');
  stopOCRCamera();
  document.getElementById('phPlaceholder').style.display = 'flex';
  document.getElementById('snapCanvasOCR').style.display = 'none';

  if (mode === 'upload') {
    document.getElementById('phStartBtn').style.display = 'none';
    document.getElementById('phUploadLabel').style.display = 'flex';
  } else {
    document.getElementById('phStartBtn').style.display = 'flex';
    document.getElementById('phUploadLabel').style.display = 'none';
  }
}

async function startOCRCamera() {
  try {
    ocrStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width:{ideal:1920}, height:{ideal:1080} }
    });
    const video = document.getElementById('videoFeedOCR');
    video.srcObject = ocrStream;
    video.style.display = 'block';
    document.getElementById('phPlaceholder').style.display = 'none';
    document.getElementById('vinOverlay').classList.add('show');
    document.getElementById('phStartBtn').style.display = 'none';
    document.getElementById('phCaptureBtn').style.display = 'flex';
    setPill('ğŸ“· Camera Live', 'scanning');
  } catch(e) {
    showErr('Camera not available â€” use Upload Photo instead.');
  }
}

function stopOCRCamera() {
  if (ocrStream) { ocrStream.getTracks().forEach(t => t.stop()); ocrStream = null; }
  document.getElementById('videoFeedOCR').style.display = 'none';
  document.getElementById('vinOverlay').classList.remove('show');
  document.getElementById('phCaptureBtn').style.display = 'none';
  document.getElementById('phStatus').classList.remove('show');
  setPill('ğŸ“ Ready', '');
}

function captureOCR() {
  const video = document.getElementById('videoFeedOCR');
  const canvas = document.getElementById('snapCanvasOCR');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  canvas.style.display = 'block';
  stopOCRCamera();
  document.getElementById('vinOverlay').classList.remove('show');
  document.getElementById('phRetakeBtn').style.display = 'flex';
  runOCROnCanvas(canvas, 'ph');
}

function resetOCRCamera() {
  stopOCRCamera();
  document.getElementById('snapCanvasOCR').style.display = 'none';
  document.getElementById('phPlaceholder').style.display = 'flex';
  document.getElementById('phRetakeBtn').style.display = 'none';
  document.getElementById('phStartBtn').style.display = photoMode === 'camera' ? 'flex' : 'none';
  document.getElementById('phUploadLabel').style.display = photoMode === 'upload' ? 'flex' : 'none';
  document.getElementById('vinConfirmPhoto').classList.remove('show');
  detectedVIN_ph = '';
}

function handleOCRUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.onload = () => {
    const canvas = document.getElementById('snapCanvasOCR');
    canvas.width = img.width; canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);
    canvas.style.display = 'block';
    document.getElementById('phPlaceholder').style.display = 'none';
    document.getElementById('phRetakeBtn').style.display = 'flex';
    document.getElementById('phUploadLabel').style.display = 'none';
    URL.revokeObjectURL(url);
    runOCROnCanvas(canvas, 'ph');
  };
  img.src = url;
  e.target.value = '';
}

async function runOCROnCanvas(canvas, target) {
  const statusId = target === 'ph' ? 'phStatus' : 'bcStatus';
  const statusTextId = target === 'ph' ? 'phStatusText' : 'bcStatusText';
  const pctId = target === 'ph' ? 'phPct' : null;

  document.getElementById(statusId).classList.add('show');
  document.getElementById(statusTextId).textContent = 'Reading VIN textâ€¦';

  try {
    const result = await Tesseract.recognize(canvas, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text' && pctId) {
          document.getElementById(pctId).textContent = Math.round(m.progress * 100) + '%';
        }
      },
      tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
    });

    document.getElementById(statusId).classList.remove('show');

    const raw = result.data.text.replace(/[^A-HJ-NPR-Z0-9]/gi, '').toUpperCase();
    const vinMatch = raw.match(/[A-HJ-NPR-Z0-9]{17}/);
    const vin = vinMatch ? vinMatch[0] : '';

    if (target === 'ph') {
      showPhotoVinConfirm(vin);
    } else {
      showBcVinConfirm(vin || '', 'OCR TEXT');
      if (!vin) showBcStatus('Could not read VIN â€” type it in the field above');
    }
  } catch(e) {
    document.getElementById(statusId).classList.remove('show');
    showErr('OCR failed â€” please enter VIN manually.');
  }
}

function showPhotoVinConfirm(vin) {
  detectedVIN_ph = vin;
  const el = document.getElementById('vinConfirmPhoto');
  const field = document.getElementById('vinConfirmPhotoField');
  const counter = document.getElementById('vcCounterPhoto');
  field.value = vin;
  counter.textContent = vin.length + ' / 17';
  counter.className = 'vc-counter' + (vin.length === 17 ? ' ready' : '');
  el.classList.add('show');
  if (!vin) {
    document.getElementById('phStatus').classList.add('show');
    document.getElementById('phStatusText').innerHTML = 'VIN not detected â€” <b style="color:var(--amber)">type or correct in the field above</b>';
  }
}

function onConfirmTypePhoto(el) {
  el.value = el.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
  detectedVIN_ph = el.value;
  const counter = document.getElementById('vcCounterPhoto');
  counter.textContent = el.value.length + ' / 17';
  counter.className = 'vc-counter' + (el.value.length === 17 ? ' ready' : '');
}

function clearVinPhoto() {
  detectedVIN_ph = '';
  document.getElementById('vinConfirmPhoto').classList.remove('show');
  document.getElementById('vinConfirmPhotoField').value = '';
  resetOCRCamera();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 3 â€” MANUAL VIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onVinType(el) {
  el.value = el.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
  const counter = document.getElementById('vinCounter');
  counter.textContent = el.value.length + ' / 17';
  counter.className = 'vin-counter' + (el.value.length === 17 ? ' ready' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD-ON ROWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addRow(name='', price='') {
  addonCount++;
  const id = addonCount;
  const row = document.createElement('div');
  row.id = `addon-${id}`;
  row.className = 'addon-row';
  row.innerHTML = `
    <input type="text" class="nf addon-name" placeholder="Option name (e.g. Dashcam)" value="${name}">
    <input type="number" class="nf addon-price" placeholder="$" value="${price}" style="width:90px">
    <button class="del-btn" onclick="document.getElementById('addon-${id}').remove()">Ã—</button>`;
  document.getElementById('addonRows').appendChild(row);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASSIFY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function classify(name) {
  const low = name.toLowerCase();
  for (const [key, info] of Object.entries(ADDON_INTEL)) {
    if (low.includes(key)) return { ...info };
  }
  return { cat:'neg', disc:35, note:'Regional dealer option. Typical 2â€“3Ã— markup.' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyze() {
  hideErr();
  let vin='', msrp=0, doc=0, state='FL';

  if (activeTab === 'barcode') {
    vin   = (document.getElementById('vinConfirmField').value || detectedVIN_bc || '').toUpperCase().trim();
    msrp  = parseFloat(document.getElementById('msrpBC').value) || 0;
    doc   = parseFloat(document.getElementById('docBC').value)  || 0;
    state = (document.getElementById('stateBC').value || 'FL').toUpperCase();
  } else if (activeTab === 'photo') {
    vin   = (document.getElementById('vinConfirmPhotoField').value || detectedVIN_ph || '').toUpperCase().trim();
    msrp  = parseFloat(document.getElementById('msrpPhoto').value) || 0;
    doc   = parseFloat(document.getElementById('docPhoto').value)  || 0;
    state = (document.getElementById('statePhoto').value || 'FL').toUpperCase();
  } else {
    vin   = document.getElementById('vinManual').value.trim().toUpperCase();
    msrp  = parseFloat(document.getElementById('msrpManual').value) || 0;
    doc   = parseFloat(document.getElementById('docManual').value)  || 0;
    state = (document.getElementById('stateManual').value || 'FL').toUpperCase();
  }

  if (vin.length !== 17) {
    showErr('VIN must be 17 characters. Check the VIN field and correct any misread characters.');
    return;
  }
  if (msrp === 0) {
    showErr('Enter the Base MSRP â€” the factory price before dealer add-ons, from the sticker.');
    return;
  }

  const addons = [];
  document.querySelectorAll('#addonRows .addon-row').forEach(row => {
    const n = row.querySelector('.addon-name')?.value?.trim();
    const p = parseFloat(row.querySelector('.addon-price')?.value) || 0;
    if (n && p > 0) addons.push({ name:n, price:p, ...classify(n) });
  });

  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true;
  btn.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:2px solid #000;border-top-color:transparent;border-radius:50%;animation:spin .7s linear infinite"></span> Decoding VINâ€¦';

  let vehicle = null;
  try {
    const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
    const d = await r.json();
    if (d.Results) vehicle = d.Results[0];
  } catch(e) {}

  btn.disabled = false;
  btn.innerHTML = '<span>âš¡</span> Get My TrueOTD Price';

  // Show vehicle name and ask user to confirm it's right before rendering
  if (vehicle && vehicle.Make && vehicle.Model) {
    const yr = vehicle.ModelYear || '';
    const mk = vehicle.Make || '';
    const mo = vehicle.Model || '';
    const confirmed = confirm(`VIN decoded as: ${yr} ${mk} ${mo}\n\nIs this the correct vehicle?`);
    if (!confirmed) {
      showErr('VIN did not match your vehicle. Check the VIN and correct any misread characters, then try again.');
      return;
    }
  }

  render(vehicle, vin, msrp, doc, state, addons);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(v, vin, msrp, doc, state, addons) {
  const tax  = TAX[state] ?? 0.06;
  const reg  = REG[state] ?? 175;
  const docT = doc * 0.50;

  const refItems = addons.filter(a => a.cat === 'ref');
  const negItems = addons.filter(a => a.cat === 'neg');
  const negSavings = negItems.reduce((s,a) => s + a.price*(a.disc/100), 0);
  const negTotal   = negItems.reduce((s,a) => s + a.price, 0);

  const stickerBase = msrp + addons.reduce((s,a)=>s+a.price,0) + doc;
  const stickerOTD  = stickerBase + stickerBase*tax + reg;
  const gcBase      = msrp + (negTotal - negSavings) + docT;
  const gcOTD       = gcBase + gcBase*tax + reg;
  const savings     = stickerOTD - gcOTD;
  const savPct      = (savings/stickerOTD*100).toFixed(1);

  const f  = n => '$' + Math.round(n).toLocaleString();
  const yr    = v?.ModelYear || 'â€”';
  const make  = v?.Make      || 'â€”';
  const model = v?.Model     || 'â€”';
  const trim  = v?.Trim || v?.Series || '';
  const eng   = v?.DisplacementL ? `${v.DisplacementL}L ${v.FuelTypePrimary||''}` : (v?.FuelTypePrimary||'â€”');
  const drive = v?.DriveType || 'â€”';
  const plant = v?.PlantCity ? `${v.PlantCity}, ${v.PlantState}` : 'â€”';

  let html = '';

  html += `<div class="hero">
    <div class="hcell main">
      <div class="hc-l">TrueOTD Target â€” All In</div>
      <div class="hc-v lime">${f(gcOTD)}</div>
      <div class="hc-s">Tax Â· tags Â· ${state} Â· fully negotiated</div>
      <div class="save-pct">Save up to ${f(savings)} Â· ${savPct}% off sticker</div>
    </div>
    <div class="hcell">
      <div class="hc-l">Sticker OTD</div>
      <div class="hc-v dim">${f(stickerOTD)}</div>
      <div class="hc-s">If you sign today without negotiating</div>
    </div>
    <div class="hcell">
      <div class="hc-l">You Can Save</div>
      <div class="hc-v amber">${f(savings)}</div>
      <div class="hc-s">${savPct}% recoverable</div>
    </div>
  </div>`;

  if (v && v.Make) {
    html += `<div class="vstrip">
      <div>
        <div class="vtitle">${yr} ${make} ${model}${trim?' Â· '+trim:''}</div>
        <div class="vmeta">
          <div class="vchip"><b>VIN</b> ${vin}</div>
          <div class="vchip"><b>Engine</b> ${eng}</div>
          <div class="vchip"><b>Drive</b> ${drive}</div>
          <div class="vchip"><b>Built</b> ${plant}</div>
        </div>
      </div>
      <div class="mkt-tag">âš  Dealer Add-Ons Detected</div>
    </div>`;
  }

  html += `<div class="tbl-wrap"><table>
    <thead><tr><th>Item</th><th>Action</th><th>Sticker</th><th>Target</th><th>Save</th></tr></thead><tbody>`;

  html += `<tr class="row-pay"><td><div class="iname">Base MSRP</div><div class="inote">Factory price Â· non-negotiable in current market</div></td><td><span class="tag t-pay">PAY</span></td><td>${f(msrp)}</td><td class="lime">${f(msrp)}</td><td>â€”</td></tr>`;

  negItems.forEach(a => {
    const t = Math.round(a.price*(1-a.disc/100));
    html += `<tr class="row-neg"><td><div class="iname">${a.name}</div><div class="inote">${a.note}</div></td><td><span class="tag t-neg">NEGOTIATE</span></td><td class="strike">${f(a.price)}</td><td class="amber">${f(t)}</td><td class="amber">âˆ’${a.disc}%</td></tr>`;
  });

  if (doc > 0) {
    html += `<tr class="row-neg"><td><div class="iname">Doc / Processing Fee</div><div class="inote">${state} avg $699â€“$999 Â· not legally mandated</div></td><td><span class="tag t-neg">NEGOTIATE</span></td><td class="strike">${f(doc)}</td><td class="amber">${f(docT)}</td><td class="amber">âˆ’50%</td></tr>`;
  }

  refItems.forEach(a => {
    html += `<tr class="row-ref"><td><div class="iname">${a.name}</div><div class="inote">${a.note}</div></td><td><span class="tag t-ref">REFUSE</span></td><td class="strike">${f(a.price)}</td><td class="red">$0</td><td class="red">âˆ’100%</td></tr>`;
  });

  html += `<tr class="row-fix"><td><div class="iname">${state} Sales Tax (${(tax*100).toFixed(2)}%)</div><div class="inote">Applied to negotiated base â€” lower base = less tax owed</div></td><td><span class="tag t-fix">FIXED</span></td><td>${f(stickerBase*tax)}</td><td class="lime">${f(gcBase*tax)}</td><td class="lime">${f((stickerBase-gcBase)*tax)} less</td></tr>
  <tr class="row-fix"><td><div class="iname">${state} Reg / Title / Tags (est.)</div><div class="inote">DMV fees â€” cannot be negotiated</div></td><td><span class="tag t-fix">FIXED</span></td><td>${f(reg)}</td><td>${f(reg)}</td><td>â€”</td></tr>
  <tr class="row-sticker"><td colspan="2"><div class="iname">Sticker OTD â€” no negotiation</div></td><td colspan="2" class="strike">${f(stickerOTD)}</td><td></td></tr>
  <tr class="row-total"><td colspan="2"><div class="iname lime" style="font-size:14px">âœ“ GutCheck TrueOTD Target</div></td><td colspan="2" class="lime" style="font-size:16px;font-weight:700">${f(gcOTD)}</td><td class="lime">${f(savings)} saved</td></tr>
  </tbody></table></div>`;

  html += `<div class="play">
    <div class="play-hdr">Negotiation Playbook</div>
    <div class="steps">
      <div class="step"><div class="sn">1</div><div class="st"><b>Lead with TrueOTD.</b> "My number is <span class="m">${f(gcOTD)}</span> all-in. Can you do that today?"</div></div>
      <div class="step"><div class="sn">2</div><div class="st"><b>Refuse junk immediately.</b> Screen protectors, cables, emergency kits â€” "Remove these. $0."</div></div>
      <div class="step"><div class="sn">3</div><div class="st"><b>Challenge add-on bundles.</b> "What did you pay SET for this?" Offer <span class="m">$300</span> max or cut it.</div></div>
      <div class="step"><div class="sn">4</div><div class="st"><b>Attack the doc fee.</b> "${state} avg is under $1,000. I'll pay <span class="m">${f(docT)}</span> â€” not more."</div></div>
      <div class="step"><div class="sn">5</div><div class="st"><b>Get competing quotes.</b> Other dealers within 90 min. One phone call costs nothing.</div></div>
      <div class="step"><div class="sn">6</div><div class="st"><b>Walk if needed.</b> Leave your number. End-of-month = 60% chance of a callback within 48 hrs.</div></div>
    </div>
    <div class="foot">GutCheck TrueOTD Â· VIN via NHTSA vPIC Â· ${state} tax ${(tax*100).toFixed(2)}% Â· Reg est. ${f(reg)} Â· Reference only Â· Not legal advice</div>
  </div>`;

  const el = document.getElementById('results');
  el.innerHTML = html;
  el.scrollIntoView({ behavior:'smooth', block:'start' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPill(text, cls) {
  const p = document.getElementById('statusPill');
  p.textContent = text;
  p.className = 'status-pill' + (cls ? ' ' + cls : '');
}
function showErr(msg) {
  const e = document.getElementById('errBar');
  e.textContent = msg; e.classList.add('show');
  e.scrollIntoView({ behavior:'smooth', block:'nearest' });
}
function hideErr() { document.getElementById('errBar').classList.remove('show'); }
</script>
</body>
</html>
