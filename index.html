<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>GutCheck TrueOTD</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#080a08; --s1:#0e110e; --s2:#141814; --s3:#1c221c;
  --border:#252c25; --text:#edf2ed; --muted:#6b7a6b;
  --lime:#b8f000; --lime2:#86b000; --amber:#f0a800;
  --red:#f03c30; --blue:#48b8f0; --safe:#40d878;
  --fd:'Barlow Condensed',sans-serif;
  --fb:'Barlow',sans-serif;
  --fm:'JetBrains Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:var(--fb);font-size:14px;line-height:1.5;min-height:100vh}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:rgba(8,10,8,.96);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 20px;height:56px;display:flex;align-items:center;justify-content:space-between}
.logo{font-family:var(--fd);font-size:22px;font-weight:800;letter-spacing:1px;line-height:1}
.logo .gc{color:var(--text)}.logo .sep{color:var(--muted);margin:0 3px}.logo .otd{color:var(--lime)}
.logo-tag{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px}
.pill{font-family:var(--fd);font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:5px 14px;border-radius:20px;border:1px solid var(--border);color:var(--muted);transition:all .3s}
.pill.live{background:rgba(184,240,0,.1);border-color:var(--lime2);color:var(--lime)}
.pill.ai{background:rgba(72,184,240,.1);border-color:var(--blue);color:var(--blue)}

/* LAYOUT */
.wrap{max-width:680px;margin:0 auto;padding:24px 16px 80px}

/* â”€â”€ MAIN CARD â”€â”€ */
.card{background:var(--s1);border:1px solid var(--border);border-radius:18px;overflow:hidden;margin-bottom:24px}

/* HERO BANNER */
.hero-banner{background:linear-gradient(135deg,#0a1a02,#0c1f03);padding:28px 24px;text-align:center;border-bottom:1px solid rgba(184,240,0,.12)}
.hb-icon{font-size:44px;margin-bottom:10px;display:block}
.hb-title{font-family:var(--fd);font-size:28px;font-weight:800;color:var(--lime);letter-spacing:1px;margin-bottom:6px}
.hb-sub{font-size:13px;color:var(--muted);line-height:1.65;max-width:380px;margin:0 auto}
.hb-sub b{color:var(--text)}

/* STEPS STRIP */
.steps-strip{display:grid;grid-template-columns:1fr 1fr 1fr;background:var(--s2);border-bottom:1px solid var(--border)}
.step-item{padding:12px 8px;text-align:center;border-right:1px solid var(--border)}
.step-item:last-child{border-right:none}
.step-num{font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:3px}
.step-txt{font-family:var(--fd);font-size:13px;font-weight:700;color:var(--text)}

/* CAMERA / UPLOAD AREA */
.capture-area{padding:20px}

/* Live camera */
.cam-wrap{position:relative;border-radius:14px;overflow:hidden;background:#000;border:2px solid var(--border);margin-bottom:14px;display:none}
.cam-wrap.show{display:block}
#liveVideo{width:100%;display:block;max-height:65vw;object-fit:cover}
.cam-frame{position:absolute;inset:0;pointer-events:none}
.cam-frame::before,.cam-frame::after{content:'';position:absolute;background:rgba(184,240,0,.7)}
.cam-corner{position:absolute;border-color:var(--lime);border-style:solid;width:22px;height:22px}
.cam-corner.tl{top:10px;left:10px;border-width:3px 0 0 3px;border-radius:4px 0 0 0}
.cam-corner.tr{top:10px;right:10px;border-width:3px 3px 0 0;border-radius:0 4px 0 0}
.cam-corner.bl{bottom:10px;left:10px;border-width:0 0 3px 3px;border-radius:0 0 0 4px}
.cam-corner.br{bottom:10px;right:10px;border-width:0 3px 3px 0;border-radius:0 0 4px 0}
.cam-label{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);border:1px solid rgba(184,240,0,.3);border-radius:20px;font-family:var(--fd);font-size:10px;font-weight:700;letter-spacing:2px;color:var(--lime);padding:4px 14px;white-space:nowrap}

/* Photo preview */
.photo-preview{display:none;position:relative;border-radius:14px;overflow:hidden;border:2px solid var(--border);margin-bottom:14px}
.photo-preview.show{display:block}
.photo-preview img{width:100%;display:block;max-height:55vw;object-fit:contain;background:#000}
.retake-btn{position:absolute;top:10px;right:10px;background:rgba(8,10,8,.85);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;font-family:var(--fd);font-weight:700;letter-spacing:.5px;padding:6px 12px;cursor:pointer;transition:all .15s}
.retake-btn:hover{border-color:var(--red);color:var(--red)}

/* Upload drop zone */
.drop-zone{border:2px dashed var(--border);border-radius:14px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px;position:relative}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--lime);background:rgba(184,240,0,.03)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{font-size:36px;margin-bottom:8px;display:block}
.dz-title{font-family:var(--fd);font-size:17px;font-weight:700;color:var(--text);margin-bottom:4px}
.dz-sub{font-size:12px;color:var(--muted);line-height:1.5}

/* Action buttons */
.action-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.abtn{padding:14px 10px;border-radius:11px;border:none;cursor:pointer;font-family:var(--fd);font-size:14px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.abtn.primary{background:var(--lime);color:#000}
.abtn.primary:hover{background:#ccff00;transform:translateY(-1px)}
.abtn.secondary{background:var(--s3);color:var(--text);border:1px solid var(--border)}
.abtn.secondary:hover{border-color:var(--lime)}
.abtn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

/* Capture button */
.capture-btn{width:100%;padding:15px;border-radius:11px;border:2px solid var(--lime);background:transparent;color:var(--lime);font-family:var(--fd);font-size:16px;font-weight:800;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .2s;display:none;margin-bottom:10px}
.capture-btn.show{display:block}
.capture-btn:hover{background:rgba(184,240,0,.1)}

/* Tip */
.tip{background:rgba(72,184,240,.07);border:1px solid rgba(72,184,240,.18);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:14px}
.tip b{color:var(--blue)}

/* â”€â”€ AI PROCESSING â”€â”€ */
.ai-panel{display:none;padding:24px;text-align:center;border-top:1px solid var(--border)}
.ai-panel.show{display:block}
.ai-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-title{font-family:var(--fd);font-size:18px;font-weight:800;color:var(--blue);letter-spacing:1px;margin-bottom:6px}
.ai-step{font-size:12px;color:var(--muted)}
.ai-step b{color:var(--text)}

/* â”€â”€ REVIEW PANEL â”€â”€ */
.review-panel{display:none;border-top:1px solid var(--border)}
.review-panel.show{display:block}
.review-hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:rgba(184,240,0,.05);border-bottom:1px solid rgba(184,240,0,.1)}
.review-hdr-left{font-family:var(--fd);font-size:14px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--lime)}
.ai-badge{font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:1.5px;padding:3px 10px;border-radius:3px;background:rgba(72,184,240,.15);color:var(--blue)}
.review-body{padding:20px}

/* Field groups */
.fg{margin-bottom:16px}
.fl{font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:5px}
.fi{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--fm);font-size:14px;padding:10px 12px;outline:none;transition:border-color .2s}
.fi:focus{border-color:var(--lime)}
.fi.vin{font-size:17px;letter-spacing:3px;color:var(--lime);border-color:var(--lime2)}
.fi.vin:focus{border-color:var(--lime)}
.frow3{display:grid;grid-template-columns:1fr 1fr 80px;gap:10px}
.frow2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* Addon table */
.addon-tbl{width:100%;margin-bottom:10px}
.addon-tbl-hdr{display:grid;grid-template-columns:1fr 100px 30px;gap:8px;margin-bottom:6px}
.addon-tbl-hdr span{font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
.addon-row{display:grid;grid-template-columns:1fr 100px 30px;gap:8px;margin-bottom:7px;align-items:center}
.ai-name{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;padding:8px 10px;outline:none;width:100%}
.ai-name:focus{border-color:var(--amber)}
.ai-price{background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--fm);font-size:13px;padding:8px 10px;outline:none;width:100%;text-align:right}
.ai-price:focus{border-color:var(--amber)}
.del-btn{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;width:30px;height:30px;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn:hover{border-color:var(--red);color:var(--red)}
.add-row-btn{background:none;border:1px dashed var(--border);border-radius:7px;color:var(--muted);cursor:pointer;font-size:12px;padding:7px 14px;font-family:var(--fb);transition:all .15s;width:100%}
.add-row-btn:hover{border-color:var(--amber);color:var(--amber)}

/* Price summary preview */
.price-preview{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:16px}
.pp-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(37,44,37,.4);font-size:13px}
.pp-row:last-child{border-bottom:none;padding-top:10px;margin-top:4px}
.pp-row.total{font-family:var(--fd);font-size:16px;font-weight:800}
.pp-label{color:var(--muted)}
.pp-val{font-family:var(--fm);font-size:13px}
.pp-val.lime{color:var(--lime)}
.pp-val.strike{text-decoration:line-through;color:var(--muted);font-size:12px}

/* ERROR */
.err{background:rgba(240,60,48,.1);border:1px solid rgba(240,60,48,.3);border-radius:9px;padding:11px 14px;color:var(--red);font-size:13px;margin:0 20px 14px;display:none}
.err.show{display:block}

/* ANALYZE BTN */
.go-wrap{padding:0 20px 20px}
.go-btn{width:100%;background:var(--lime);border:none;border-radius:11px;color:#000;cursor:pointer;font-family:var(--fd);font-size:20px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:16px;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px}
.go-btn:hover{background:#ccff00;transform:translateY(-1px);box-shadow:0 4px 24px rgba(184,240,0,.25)}
.go-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}

/* â”€â”€ RESULTS â”€â”€ */
#results{animation:fadeUp .4s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

.res-hero{display:grid;grid-template-columns:2fr 1fr 1fr;gap:2px;background:var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px}
.rhcell{background:var(--s1);padding:20px 16px}
.rhcell.main{background:linear-gradient(135deg,#091802,#0c2004);border:1px solid rgba(184,240,0,.15)}
.rh-l{font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.rh-v{font-family:var(--fd);font-size:34px;font-weight:800;line-height:1;letter-spacing:-1px}
.rh-v.lime{color:var(--lime)}.rh-v.dim{color:#3d473d}.rh-v.amber{color:var(--amber)}
.rh-s{font-size:11px;color:var(--muted);margin-top:5px}
.save-badge{display:inline-block;background:rgba(184,240,0,.12);border:1px solid rgba(184,240,0,.3);border-radius:20px;color:var(--lime);font-family:var(--fd);font-size:12px;font-weight:700;padding:3px 11px;margin-top:8px}

.vstrip{background:var(--s1);border:1px solid var(--border);border-radius:11px;padding:14px 16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
.vtitle{font-family:var(--fd);font-size:20px;font-weight:800}
.vmeta{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.vchip{font-size:10px;background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:2px 8px;color:var(--muted)}
.vchip b{color:#9aaa9a}
.dealer-tag{font-family:var(--fd);font-size:10px;font-weight:700;letter-spacing:1px;padding:4px 12px;border-radius:20px;background:rgba(240,168,0,.12);color:var(--amber);border:1px solid rgba(240,168,0,.25);white-space:nowrap}

.tbl-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px}
table{width:100%;border-collapse:collapse}
thead tr{background:var(--s2)}
th{font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:10px 14px;text-align:left;border-bottom:1px solid var(--border)}
th:nth-child(n+3){text-align:right}
td{padding:11px 14px;border-bottom:1px solid rgba(37,44,37,.4);vertical-align:middle;font-size:13px}
tr:last-child td{border-bottom:none}
td:nth-child(n+3){text-align:right;font-family:var(--fm);font-size:12px}
.row-pay td:first-child{border-left:3px solid var(--safe);padding-left:11px}
.row-neg td:first-child{border-left:3px solid var(--amber);padding-left:11px}
.row-ref td:first-child{border-left:3px solid var(--red);padding-left:11px}
.row-fix td:first-child{border-left:3px solid var(--blue);padding-left:11px}
.row-dest td:first-child{border-left:3px solid #888;padding-left:11px}
.row-total td{background:rgba(184,240,0,.05);font-weight:700}
.row-sticker td{color:var(--muted)}
.iname{font-weight:600;color:var(--text)}.inote{font-size:11px;color:var(--muted);margin-top:2px}
.tag{display:inline-block;font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 8px;border-radius:3px}
.t-pay{background:rgba(64,216,120,.15);color:var(--safe)}
.t-neg{background:rgba(240,168,0,.15);color:var(--amber)}
.t-ref{background:rgba(240,60,48,.15);color:var(--red)}
.t-fix{background:rgba(72,184,240,.15);color:var(--blue)}
.t-dest{background:rgba(180,180,180,.12);color:#aaa}
.strike{text-decoration:line-through;color:var(--muted)}
.c-lime{color:var(--lime)}.c-amber{color:var(--amber)}.c-red{color:var(--red)}

.play-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px}
.play-hdr{font-family:var(--fd);font-size:12px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px}
.play-steps{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ps{display:flex;gap:10px;align-items:flex-start}
.psn{background:var(--lime);color:#000;font-family:var(--fd);font-size:10px;font-weight:800;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.pst{font-size:12px;color:#8a9a8a;line-height:1.55}
.pst b{color:var(--text)}.pst .m{color:var(--lime);font-family:var(--fm);font-size:11px}
.res-foot{font-size:10px;color:#3d473d;margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}

@media(max-width:560px){
  .res-hero{grid-template-columns:1fr 1fr}
  .rhcell.main{grid-column:1/-1}
  .rh-v{font-size:28px}
  .frow3{grid-template-columns:1fr 1fr}
  .play-steps{grid-template-columns:1fr}
  th:nth-child(4),td:nth-child(4){display:none}
}
</style>
</head>
<body>

<div class="topbar">
  <div>
    <div class="logo"><span class="gc">GutCheck</span><span class="sep">|</span><span class="otd">TrueOTD</span></div>
    <div class="logo-tag">Conflict-Free Car Price Intelligence</div>
  </div>
  <div class="pill" id="pill">ğŸ“ Ready</div>
</div>

<div class="wrap">
<div class="card">

  <!-- HERO -->
  <div class="hero-banner">
    <span class="hb-icon">ğŸ“‹</span>
    <div class="hb-title">Photograph the Window Sticker</div>
    <div class="hb-sub">Take one photo of the <b>entire window sticker</b>. AI reads the VIN, base MSRP, destination fee, every dealer add-on and price â€” then calculates your TrueOTD target automatically.</div>
  </div>

  <!-- HOW IT WORKS STRIP -->
  <div class="steps-strip">
    <div class="step-item">
      <span class="step-num">Step 1</span>
      <div class="step-txt">ğŸ“· Photo</div>
    </div>
    <div class="step-item">
      <span class="step-num">Step 2</span>
      <div class="step-txt">ğŸ¤– AI Reads</div>
    </div>
    <div class="step-item">
      <span class="step-num">Step 3</span>
      <div class="step-txt">âš¡ Your Price</div>
    </div>
  </div>

  <!-- CAPTURE AREA -->
  <div class="capture-area">

    <!-- Live camera view -->
    <div class="cam-wrap" id="camWrap">
      <video id="liveVideo" autoplay playsinline muted></video>
      <div class="cam-frame">
        <div class="cam-corner tl"></div>
        <div class="cam-corner tr"></div>
        <div class="cam-corner bl"></div>
        <div class="cam-corner br"></div>
      </div>
      <div class="cam-label">FIT FULL STICKER IN FRAME</div>
    </div>

    <!-- Capture button (shows when camera is live) -->
    <button class="capture-btn" id="captureBtn" onclick="capturePhoto()">
      âŠ™ &nbsp;Capture Sticker
    </button>

    <!-- Photo preview -->
    <div class="photo-preview" id="photoPreview">
      <img id="previewImg" src="" alt="Sticker photo">
      <button class="retake-btn" onclick="resetAll()">â†º Retake</button>
    </div>

    <!-- Drop zone (shown by default) -->
    <div class="drop-zone" id="dropZone">
      <input type="file" accept="image/*" id="fileInput" onchange="handleFile(event)">
      <span class="dz-icon">ğŸ–¼ï¸</span>
      <div class="dz-title">Upload Sticker Photo</div>
      <div class="dz-sub">Tap to choose from camera roll<br>or drag a photo here</div>
    </div>

    <!-- Tip -->
    <div class="tip">
      <b>ğŸ“Œ Best results:</b> Capture the <b>full sticker</b> including the pricing column on the right side. That's where Base MSRP, dealer add-ons, and destination fee are listed. Landscape orientation works well on larger stickers.
    </div>

    <!-- Two capture buttons -->
    <div class="action-row" id="actionRow">
      <button class="abtn primary" onclick="startCamera()">ğŸ“· Use Camera</button>
      <label class="abtn secondary" style="cursor:pointer">
        ğŸ“ Camera Roll
        <input type="file" accept="image/*" onchange="handleFile(event)" style="position:absolute;opacity:0;width:0;height:0">
      </label>
    </div>

  </div><!-- /capture-area -->

  <!-- AI PROCESSING -->
  <div class="ai-panel" id="aiPanel">
    <div class="ai-spinner"></div>
    <div class="ai-title">ğŸ¤– Reading Stickerâ€¦</div>
    <div class="ai-step" id="aiStep">Analyzing sticker photo â€” extracting all pricing data</div>
  </div>

  <!-- REVIEW PANEL -->
  <div class="review-panel" id="reviewPanel">
    <div class="review-hdr">
      <div class="review-hdr-left">âœ“ Review Extracted Data</div>
      <div class="ai-badge">ğŸ¤– AI READ</div>
    </div>
    <div class="review-body">

      <!-- VIN -->
      <div class="fg">
        <span class="fl">VIN â€” 17 Characters</span>
        <input type="text" class="fi vin" id="rVin" maxlength="17"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,'')" placeholder="VIN not found â€” type here">
      </div>

      <!-- Vehicle info (read-only display, filled by AI) -->
      <div class="fg" id="vehicleInfo" style="display:none">
        <span class="fl">Vehicle</span>
        <div class="fi" id="vehicleDisplay" style="color:var(--muted);cursor:default"></div>
      </div>

      <!-- MSRP / Destination / Doc / State -->
      <div class="frow3" style="margin-bottom:16px">
        <div class="fg" style="margin-bottom:0">
          <span class="fl">Base MSRP ($)</span>
          <input type="number" class="fi" id="rMsrp" placeholder="Factory price" oninput="updatePricePreview()">
        </div>
        <div class="fg" style="margin-bottom:0">
          <span class="fl">Destination Fee ($)</span>
          <input type="number" class="fi" id="rDest" placeholder="Delivery charge" oninput="updatePricePreview()">
        </div>
        <div class="fg" style="margin-bottom:0">
          <span class="fl">State</span>
          <input type="text" class="fi" id="rState" value="FL" maxlength="2" style="text-transform:uppercase" oninput="updatePricePreview()">
        </div>
      </div>
      <div class="frow2" style="margin-bottom:16px">
        <div class="fg" style="margin-bottom:0">
          <span class="fl">Doc / Processing Fee ($)</span>
          <input type="number" class="fi" id="rDoc" placeholder="0" oninput="updatePricePreview()">
        </div>
        <div class="fg" style="margin-bottom:0">
          <span class="fl">Total Sticker Price ($)</span>
          <input type="number" class="fi" id="rSticker" placeholder="As shown on sticker" style="color:var(--muted)" oninput="updatePricePreview()">
        </div>
      </div>

      <!-- Dealer add-ons -->
      <span class="fl" style="display:block;margin-bottom:8px">Dealer Add-Ons &amp; Installed Options</span>
      <div class="addon-tbl-hdr">
        <span>Item Name</span>
        <span style="text-align:right">Price</span>
        <span></span>
      </div>
      <div id="addonRows"></div>
      <button class="add-row-btn" onclick="addAddon()">+ Add item</button>

      <!-- Live price preview -->
      <div class="price-preview" id="pricePreview" style="display:none">
        <div class="pp-row">
          <span class="pp-label">Sticker Total (as-is)</span>
          <span class="pp-val strike" id="pp-sticker">â€”</span>
        </div>
        <div class="pp-row">
          <span class="pp-label">Your TrueOTD Target</span>
          <span class="pp-val lime" id="pp-target">â€”</span>
        </div>
        <div class="pp-row total">
          <span style="color:var(--lime)">Potential Savings</span>
          <span class="pp-val lime" id="pp-save">â€”</span>
        </div>
      </div>

    </div>
  </div>

  <!-- ERROR -->
  <div class="err" id="errBar"></div>

  <!-- ANALYZE BUTTON -->
  <div class="go-wrap" id="goWrap" style="display:none">
    <button class="go-btn" id="goBtn" onclick="analyze()">
      <span>âš¡</span> Get My TrueOTD Price
    </button>
  </div>

</div><!-- /card -->

<div id="results"></div>
</div><!-- /wrap -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TAX={AL:.04,AK:0,AZ:.056,AR:.065,CA:.0725,CO:.029,CT:.0635,DE:0,FL:.06,GA:.04,HI:.04,ID:.06,IL:.0625,IN:.07,IA:.06,KS:.065,KY:.06,LA:.0445,ME:.055,MD:.06,MA:.0625,MI:.06,MN:.06875,MS:.07,MO:.04225,MT:0,NE:.055,NV:.0685,NH:0,NJ:.06625,NM:.05125,NY:.04,NC:.03,ND:.05,OH:.0575,OK:.045,OR:0,PA:.06,RI:.07,SC:.06,SD:.045,TN:.07,TX:.0625,UT:.0485,VT:.06,VA:.043,WA:.065,WV:.06,WI:.05,WY:.04,DC:.06};
const REG={FL:225,PA:130,TX:150,CA:200,NY:180,OH:100,GA:120,NC:100,VA:140,NJ:150,TN:110,SC:100};
const INTEL={
  'toyoguard':{cat:'neg',disc:55,note:'SET bundle Â· real value ~$300'},
  'trd':{cat:'neg',disc:45,note:'OEM part â€” marked up 2Ã—'},
  'ambient':{cat:'neg',disc:45,note:'Dealer-installed Â· negotiate to $250'},
  'dashcam':{cat:'ref',disc:100,note:'Buy on Amazon for $60â€“$120'},
  'cargo':{cat:'neg',disc:40,note:'Marked up 2â€“3Ã—'},
  'console safe':{cat:'ref',disc:100,note:'Online cost ~$60'},
  'safe':{cat:'ref',disc:100,note:'Online cost ~$60'},
  'screen protector':{cat:'ref',disc:100,note:'Dealer cost <$5'},
  'multimedia':{cat:'ref',disc:100,note:'Dealer cost <$5'},
  'emergency':{cat:'ref',disc:100,note:'Amazon ~$25'},
  'phone cable':{cat:'ref',disc:100,note:'USB cables Â· cost <$5'},
  'cable':{cat:'ref',disc:100,note:'USB cables Â· cost <$5'},
  'nitrogen':{cat:'ref',disc:100,note:'Free air works fine'},
  'vin etch':{cat:'ref',disc:100,note:'Insurance benefit minimal'},
  'paint':{cat:'neg',disc:60,note:'DIY or 3rd party for <$100'},
  'fabric':{cat:'ref',disc:100,note:'Scotchguard = $10'},
  'protection':{cat:'neg',disc:55,note:'Negotiate hard or refuse'},
  'lo-jack':{cat:'neg',disc:50,note:'Subscription model â€” negotiate'},
  'lo jack':{cat:'neg',disc:50,note:'Subscription model â€” negotiate'},
  'wheel lock':{cat:'ref',disc:100,note:'Buy online for $15'},
  'mud flap':{cat:'neg',disc:40,note:'OEM part, marked up'},
  'mudguard':{cat:'neg',disc:40,note:'OEM part, marked up'},
  'splash guard':{cat:'neg',disc:40,note:'OEM part, marked up'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let camStream = null;
let photoB64 = '';
let addonCount = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startCamera() {
  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
    });
    const v = document.getElementById('liveVideo');
    v.srcObject = camStream;
    document.getElementById('camWrap').classList.add('show');
    document.getElementById('dropZone').style.display = 'none';
    document.getElementById('actionRow').style.display = 'none';
    document.getElementById('captureBtn').classList.add('show');
    setPill('ğŸ“· Camera Live', 'live');
  } catch(e) {
    showErr('Camera not available â€” use "Camera Roll" to upload a photo instead.');
  }
}

function capturePhoto() {
  const v = document.getElementById('liveVideo');
  const c = document.createElement('canvas');
  c.width = v.videoWidth; c.height = v.videoHeight;
  c.getContext('2d').drawImage(v, 0, 0);
  const dataUrl = c.toDataURL('image/jpeg', 0.92);
  photoB64 = dataUrl.split(',')[1];
  stopCamera();
  showPhoto(dataUrl);
  sendToAI(photoB64);
}

function stopCamera() {
  if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
  document.getElementById('camWrap').classList.remove('show');
  document.getElementById('captureBtn').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFile(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    // Resize large images before sending to AI
    resizeImage(dataUrl, 1600, (resized) => {
      photoB64 = resized.split(',')[1];
      showPhoto(resized);
      sendToAI(photoB64);
    });
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function resizeImage(dataUrl, maxWidth, cb) {
  const img = new Image();
  img.onload = () => {
    const scale = Math.min(1, maxWidth / img.width);
    const c = document.createElement('canvas');
    c.width = Math.round(img.width * scale);
    c.height = Math.round(img.height * scale);
    c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
    cb(c.toDataURL('image/jpeg', 0.88));
  };
  img.src = dataUrl;
}

function showPhoto(src) {
  document.getElementById('previewImg').src = src;
  document.getElementById('photoPreview').classList.add('show');
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('actionRow').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetAll() {
  stopCamera();
  photoB64 = '';
  addonCount = 0;
  document.getElementById('photoPreview').classList.remove('show');
  document.getElementById('dropZone').style.display = 'block';
  document.getElementById('actionRow').style.display = 'grid';
  document.getElementById('aiPanel').classList.remove('show');
  document.getElementById('reviewPanel').classList.remove('show');
  document.getElementById('goWrap').style.display = 'none';
  document.getElementById('pricePreview').style.display = 'none';
  document.getElementById('addonRows').innerHTML = '';
  document.getElementById('vehicleInfo').style.display = 'none';
  document.getElementById('results').innerHTML = '';
  hideErr();
  setPill('ğŸ“ Ready', '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI STICKER READ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendToAI(b64) {
  setPill('ğŸ¤– Readingâ€¦', 'ai');
  document.getElementById('aiPanel').classList.add('show');
  document.getElementById('reviewPanel').classList.remove('show');
  document.getElementById('goWrap').style.display = 'none';
  hideErr();

  const steps = [
    'Locating VIN and vehicle informationâ€¦',
    'Reading Base MSRP and destination feeâ€¦',
    'Extracting dealer add-ons and pricesâ€¦',
    'Calculating sticker totalâ€¦'
  ];
  let si = 0;
  const stepEl = document.getElementById('aiStep');
  const stepTimer = setInterval(() => {
    stepEl.textContent = steps[Math.min(si++, steps.length - 1)];
  }, 1800);

  const prompt = `You are analyzing a vehicle window sticker (Monroney label) photo.

Extract ALL pricing data and return ONLY a valid JSON object â€” no markdown, no explanation, nothing else.

Required JSON structure:
{
  "vin": "17-char VIN string or null",
  "year": "4-digit model year or null",
  "make": "brand name or null",
  "model": "model name or null", 
  "trim": "trim level or null",
  "color": "exterior color or null",
  "msrp": base factory MSRP as integer (labeled Base Price, MSRP, or Base Vehicle Price â€” NOT including destination, NOT including any dealer add-ons),
  "destination": destination and delivery charge as integer (labeled Destination & Delivery, Destination Charge, or similar) or 0,
  "total_sticker": the final total as shown at bottom of sticker pricing column as integer or 0,
  "doc_fee": document/processing/dealer fee as integer or 0,
  "state": "2-letter state from assembly point or TX if Toyota" ,
  "addons": [
    { "name": "exact line item name from sticker", "price": integer }
  ]
}

CRITICAL RULES:
- msrp = ONLY the base factory price. Do NOT add destination to it.
- destination = the delivery/freight charge (typically $1,000â€“$2,000 for most vehicles)
- addons = ONLY dealer-installed items with their own line item prices (accessories, protection packages, appearance packages, ToyoGuard, etc.). Do NOT include standard factory options that are part of MSRP.
- total_sticker = the grand total printed at the bottom of the pricing section
- If ANY pricing panel is cut off or not visible, set those fields to 0 and note it
- Return ONLY the JSON object, starting with { and ending with }`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': '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', 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: b64 } },
            { type: 'text', text: prompt }
          ]
        }]
      })
    });

    clearInterval(stepTimer);
    const data = await resp.json();
    const text = (data.content || []).map(c => c.text || '').join('').trim();
    const match = text.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('No data returned â€” try a clearer photo');
    const d = JSON.parse(match[0]);

    document.getElementById('aiPanel').classList.remove('show');
    populateReview(d);
    setPill('âœ“ Sticker Read', 'live');

  } catch(e) {
    clearInterval(stepTimer);
    document.getElementById('aiPanel').classList.remove('show');
    setPill('ğŸ“ Ready', '');
    showErr('Could not read sticker: ' + e.message + '. Try a clearer, better-lit photo that includes the full pricing column on the right side of the sticker.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPULATE REVIEW PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateReview(d) {
  document.getElementById('rVin').value    = d.vin || '';
  document.getElementById('rMsrp').value  = d.msrp || '';
  document.getElementById('rDest').value  = d.destination || '';
  document.getElementById('rDoc').value   = d.doc_fee || '';
  document.getElementById('rState').value = d.state || 'FL';
  document.getElementById('rSticker').value = d.total_sticker || '';

  // Vehicle display
  if (d.make || d.model) {
    const parts = [d.year, d.make, d.model, d.trim].filter(Boolean).join(' ');
    document.getElementById('vehicleDisplay').textContent = parts + (d.color ? '  Â·  ' + d.color : '');
    document.getElementById('vehicleInfo').style.display = 'block';
  }

  // Add-ons
  document.getElementById('addonRows').innerHTML = '';
  addonCount = 0;
  (d.addons || []).forEach(a => addAddon(a.name, a.price));

  document.getElementById('reviewPanel').classList.add('show');
  document.getElementById('goWrap').style.display = 'block';
  updatePricePreview();
  document.getElementById('reviewPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD-ON ROWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addAddon(name = '', price = '') {
  addonCount++;
  const id = addonCount;
  const row = document.createElement('div');
  row.id = `ar-${id}`;
  row.className = 'addon-row';
  row.innerHTML = `
    <input type="text" class="ai-name" value="${escHtml(String(name))}" placeholder="Add-on name" oninput="updatePricePreview()">
    <input type="number" class="ai-price" value="${price}" placeholder="0" oninput="updatePricePreview()">
    <button class="del-btn" onclick="document.getElementById('ar-${id}').remove();updatePricePreview()">Ã—</button>`;
  document.getElementById('addonRows').appendChild(row);
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE PRICE PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePricePreview() {
  const msrp  = parseFloat(document.getElementById('rMsrp').value) || 0;
  const dest  = parseFloat(document.getElementById('rDest').value) || 0;
  const doc   = parseFloat(document.getElementById('rDoc').value) || 0;
  const state = (document.getElementById('rState').value || 'FL').toUpperCase();
  if (!msrp) { document.getElementById('pricePreview').style.display = 'none'; return; }

  const addons = getAddons();
  const tax = TAX[state] ?? 0.06;
  const reg = REG[state] ?? 175;

  const refItems = addons.filter(a => a.cat === 'ref');
  const negItems = addons.filter(a => a.cat === 'neg');
  const negSavings = negItems.reduce((s, a) => s + a.price * (a.disc / 100), 0);
  const negTotal   = negItems.reduce((s, a) => s + a.price, 0);

  const stickerBase = msrp + dest + addons.reduce((s,a)=>s+a.price,0) + doc;
  const stickerOTD  = stickerBase + stickerBase * tax + reg;
  const gcBase      = msrp + dest + (negTotal - negSavings) + doc * 0.5;
  const gcOTD       = gcBase + gcBase * tax + reg;
  const savings     = stickerOTD - gcOTD;

  const f = n => '$' + Math.round(n).toLocaleString();
  document.getElementById('pp-sticker').textContent = f(stickerOTD);
  document.getElementById('pp-target').textContent  = f(gcOTD);
  document.getElementById('pp-save').textContent    = f(savings);
  document.getElementById('pricePreview').style.display = 'block';
}

function getAddons() {
  const rows = document.querySelectorAll('#addonRows .addon-row');
  const result = [];
  rows.forEach(row => {
    const n = row.querySelector('.ai-name')?.value?.trim();
    const p = parseFloat(row.querySelector('.ai-price')?.value) || 0;
    if (n && p > 0) result.push({ name: n, price: p, ...classify(n) });
  });
  return result;
}

function classify(name) {
  const low = name.toLowerCase();
  for (const [k, v] of Object.entries(INTEL)) {
    if (low.includes(k)) return { ...v };
  }
  return { cat: 'neg', disc: 35, note: 'Dealer-installed option. Typical 2â€“3Ã— markup.' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYZE â†’ RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyze() {
  hideErr();
  const vin   = document.getElementById('rVin').value.toUpperCase().trim();
  const msrp  = parseFloat(document.getElementById('rMsrp').value) || 0;
  const dest  = parseFloat(document.getElementById('rDest').value) || 0;
  const doc   = parseFloat(document.getElementById('rDoc').value) || 0;
  const state = (document.getElementById('rState').value || 'FL').toUpperCase();
  const addons = getAddons();

  if (msrp === 0) { showErr('Base MSRP is missing â€” check the sticker photo and enter it above.'); return; }

  const btn = document.getElementById('goBtn');
  btn.disabled = true;
  btn.innerHTML = '<span style="display:inline-block;width:18px;height:18px;border:2px solid #000;border-top-color:transparent;border-radius:50%;animation:spin .7s linear infinite"></span>&nbsp; Decoding VINâ€¦';

  let vehicle = null;
  if (vin.length === 17) {
    try {
      const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
      const d = await r.json();
      if (d.Results) vehicle = d.Results[0];
    } catch(e) {}
  }

  btn.disabled = false;
  btn.innerHTML = '<span>âš¡</span> Get My TrueOTD Price';

  // Verify correct vehicle
  if (vehicle && vehicle.Make && vehicle.Model) {
    const label = [vehicle.ModelYear, vehicle.Make, vehicle.Model].filter(Boolean).join(' ');
    if (!confirm(`VIN decoded as:\n\n${label}\n\nIs this the correct vehicle?`)) {
      showErr('Please correct the VIN in the field above and try again.');
      return;
    }
  }

  render(vehicle, vin, msrp, dest, doc, state, addons);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(v, vin, msrp, dest, doc, state, addons) {
  const tax  = TAX[state] ?? 0.06;
  const reg  = REG[state] ?? 175;
  const docT = doc * 0.5;

  const refItems = addons.filter(a => a.cat === 'ref');
  const negItems = addons.filter(a => a.cat === 'neg');
  const negSavings = negItems.reduce((s,a) => s + a.price*(a.disc/100), 0);
  const negTotal   = negItems.reduce((s,a) => s + a.price, 0);

  // Sticker OTD = everything including destination
  const stickerBase = msrp + dest + addons.reduce((s,a)=>s+a.price,0) + doc;
  const stickerOTD  = stickerBase + stickerBase*tax + reg;

  // TrueOTD = msrp + dest (non-negotiable) + negotiated addons + half doc
  const gcBase = msrp + dest + (negTotal - negSavings) + docT;
  const gcOTD  = gcBase + gcBase*tax + reg;
  const savings = stickerOTD - gcOTD;
  const savPct = (savings/stickerOTD*100).toFixed(1);

  const f  = n => '$' + Math.round(n).toLocaleString();
  const yr    = v?.ModelYear || '';
  const make  = v?.Make      || '';
  const model = v?.Model     || '';
  const trim  = v?.Trim || v?.Series || '';
  const eng   = v?.DisplacementL ? `${v.DisplacementL}L ${v.FuelTypePrimary||''}` : (v?.FuelTypePrimary||'');
  const drive = v?.DriveType || '';
  const plant = v?.PlantCity ? `${v.PlantCity}, ${v.PlantState}` : '';

  let h = '';

  // HERO
  h += `<div class="res-hero">
    <div class="rhcell main">
      <div class="rh-l">TrueOTD Target â€” All In</div>
      <div class="rh-v lime">${f(gcOTD)}</div>
      <div class="rh-s">Tax Â· tags Â· ${state} Â· fully negotiated</div>
      <div class="save-badge">Save up to ${f(savings)} Â· ${savPct}% off sticker</div>
    </div>
    <div class="rhcell">
      <div class="rh-l">Full Sticker OTD</div>
      <div class="rh-v dim">${f(stickerOTD)}</div>
      <div class="rh-s">No negotiation</div>
    </div>
    <div class="rhcell">
      <div class="rh-l">You Can Save</div>
      <div class="rh-v amber">${f(savings)}</div>
      <div class="rh-s">${savPct}% recoverable</div>
    </div>
  </div>`;

  // Vehicle strip
  if (make) {
    h += `<div class="vstrip">
      <div>
        <div class="vtitle">${[yr,make,model,trim].filter(Boolean).join(' ')}</div>
        <div class="vmeta">
          ${vin ? `<div class="vchip"><b>VIN</b> ${vin}</div>` : ''}
          ${eng  ? `<div class="vchip"><b>Engine</b> ${eng}</div>` : ''}
          ${drive ? `<div class="vchip"><b>Drive</b> ${drive}</div>` : ''}
          ${plant ? `<div class="vchip"><b>Built</b> ${plant}</div>` : ''}
        </div>
      </div>
      ${addons.length > 0 ? '<div class="dealer-tag">âš  Dealer Add-Ons Detected</div>' : ''}
    </div>`;
  }

  // Table
  h += `<div class="tbl-card"><table>
    <thead><tr><th>Line Item</th><th>Action</th><th>Sticker</th><th>Target</th><th>Save</th></tr></thead><tbody>`;

  // Base MSRP
  h += `<tr class="row-pay">
    <td><div class="iname">Base MSRP</div><div class="inote">Factory price â€” cannot be negotiated</div></td>
    <td><span class="tag t-pay">PAY</span></td>
    <td>${f(msrp)}</td><td class="c-lime">${f(msrp)}</td><td>â€”</td></tr>`;

  // Negotiate items
  negItems.forEach(a => {
    const t = Math.round(a.price*(1-a.disc/100));
    h += `<tr class="row-neg">
      <td><div class="iname">${a.name}</div><div class="inote">${a.note}</div></td>
      <td><span class="tag t-neg">NEGOTIATE</span></td>
      <td class="strike">${f(a.price)}</td><td class="c-amber">${f(t)}</td><td class="c-amber">âˆ’${a.disc}%</td></tr>`;
  });

  // Doc fee
  if (doc > 0) {
    h += `<tr class="row-neg">
      <td><div class="iname">Doc / Processing Fee</div><div class="inote">${state} avg $699â€“$999 Â· not legally mandated Â· push back hard</div></td>
      <td><span class="tag t-neg">NEGOTIATE</span></td>
      <td class="strike">${f(doc)}</td><td class="c-amber">${f(docT)}</td><td class="c-amber">âˆ’50%</td></tr>`;
  }

  // Refuse items
  refItems.forEach(a => {
    h += `<tr class="row-ref">
      <td><div class="iname">${a.name}</div><div class="inote">${a.note}</div></td>
      <td><span class="tag t-ref">REFUSE</span></td>
      <td class="strike">${f(a.price)}</td><td class="c-red">$0</td><td class="c-red">âˆ’100%</td></tr>`;
  });

  // Destination (non-negotiable, shown separately)
  if (dest > 0) {
    h += `<tr class="row-dest">
      <td><div class="iname">Destination &amp; Delivery</div><div class="inote">Federal freight charge â€” fixed by manufacturer, cannot be negotiated</div></td>
      <td><span class="tag t-dest">FIXED</span></td>
      <td>${f(dest)}</td><td>${f(dest)}</td><td>â€”</td></tr>`;
  }

  // Tax
  h += `<tr class="row-fix">
    <td><div class="iname">${state} Sales Tax (${(tax*100).toFixed(2)}%)</div><div class="inote">Applied to negotiated base â€” lower base = less tax paid</div></td>
    <td><span class="tag t-fix">FIXED</span></td>
    <td>${f(stickerBase*tax)}</td><td class="c-lime">${f(gcBase*tax)}</td>
    <td class="c-lime">${f((stickerBase-gcBase)*tax)} less</td></tr>
  <tr class="row-fix">
    <td><div class="iname">${state} Registration / Title / Tags</div><div class="inote">DMV fees â€” fixed by state law</div></td>
    <td><span class="tag t-fix">FIXED</span></td>
    <td>${f(reg)}</td><td>${f(reg)}</td><td>â€”</td></tr>`;

  // Totals
  h += `<tr class="row-sticker">
    <td colspan="2"><div class="iname">Full Sticker OTD â€” no negotiation</div></td>
    <td colspan="2" class="strike">${f(stickerOTD)}</td><td></td></tr>
  <tr class="row-total">
    <td colspan="2"><div class="iname c-lime" style="font-size:14px">âœ“ GutCheck TrueOTD Target</div></td>
    <td colspan="2" class="c-lime" style="font-size:17px">${f(gcOTD)}</td>
    <td class="c-lime">${f(savings)} saved</td></tr>
  </tbody></table></div>`;

  // Playbook
  h += `<div class="play-card">
    <div class="play-hdr">Negotiation Playbook</div>
    <div class="play-steps">
      <div class="ps"><div class="psn">1</div><div class="pst"><b>Lead with your number.</b> "My all-in price is <span class="m">${f(gcOTD)}</span>. Can you do that today?"</div></div>
      <div class="ps"><div class="psn">2</div><div class="pst"><b>Refuse junk immediately.</b> Screen protectors, cables, emergency kits â€” "Remove all of these. $0."</div></div>
      <div class="ps"><div class="psn">3</div><div class="pst"><b>Attack add-on bundles.</b> "What did the distributor charge you for this?" Offer max <span class="m">$300</span> or walk.</div></div>
      <div class="ps"><div class="psn">4</div><div class="pst"><b>Cut the doc fee in half.</b> "I'll pay <span class="m">${f(docT)}</span> â€” not a dollar more. That's my final number."</div></div>
      <div class="ps"><div class="psn">5</div><div class="pst"><b>Get competing quotes.</b> Call one other dealer within 90 minutes. A phone call costs nothing.</div></div>
      <div class="ps"><div class="psn">6</div><div class="pst"><b>Walk if needed.</b> Leave your number. End-of-month = 60% chance of a callback within 48 hours.</div></div>
    </div>
    <div class="res-foot">GutCheck TrueOTD Â· AI Vision + NHTSA vPIC Â· ${state} tax ${(tax*100).toFixed(2)}% Â· Reg est. ${f(reg)} Â· Reference only, not legal or financial advice</div>
  </div>`;

  const el = document.getElementById('results');
  el.innerHTML = h;
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPill(t, c) {
  const p = document.getElementById('pill');
  p.textContent = t;
  p.className = 'pill' + (c ? ' ' + c : '');
}
function showErr(m) {
  const e = document.getElementById('errBar');
  e.textContent = m; e.classList.add('show');
}
function hideErr() { document.getElementById('errBar').classList.remove('show'); }
</script>
</body>
</html>
