<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>GutCheck TrueOTD</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
<style>
:root {
  --bg:     #080a08;
  --s1:     #0e110e;
  --s2:     #141814;
  --s3:     #1c221c;
  --border: #252c25;
  --text:   #edf2ed;
  --muted:  #6b7a6b;
  --dim:    #3d473d;
  --lime:   #b8f000;
  --lime2:  #86b000;
  --amber:  #f0a800;
  --red:    #f03c30;
  --blue:   #48b8f0;
  --safe:   #40d878;
  --font-display: 'Barlow Condensed', sans-serif;
  --font-body:    'Barlow', sans-serif;
  --font-mono:    'JetBrains Mono', monospace;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 14px;
  line-height: 1.5;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(8,10,8,0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 800;
  letter-spacing: 1px;
  line-height: 1;
}
.logo .gc { color: var(--text); }
.logo .sep { color: var(--muted); margin: 0 3px; }
.logo .otd { color: var(--lime); }
.logo-tag {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  margin-top: 2px;
}
.mode-pill {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 4px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  color: var(--muted);
  cursor: pointer;
  transition: all .2s;
}
.mode-pill.lot { background: rgba(184,240,0,0.1); border-color: var(--lime2); color: var(--lime); }

/* ‚îÄ‚îÄ MAIN WRAP ‚îÄ‚îÄ */
.wrap { max-width: 780px; margin: 0 auto; padding: 24px 16px 60px; }

/* ‚îÄ‚îÄ INPUT CARD ‚îÄ‚îÄ */
.input-card {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
}

/* MODE TABS */
.mode-tabs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}
.mtab {
  padding: 14px;
  text-align: center;
  cursor: pointer;
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.mtab.active { color: var(--lime); border-bottom-color: var(--lime); background: rgba(184,240,0,0.04); }
.mtab-icon { font-size: 16px; }

/* CAMERA PANEL */
.camera-panel { padding: 20px; display: none; }
.camera-panel.active { display: block; }

.cam-area {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  background: #000;
  aspect-ratio: 16/7;
  margin-bottom: 14px;
  border: 1px solid var(--border);
}
#cameraFeed, #previewCanvas {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
#previewCanvas { display: none; position: absolute; top: 0; left: 0; }

/* VIN targeting overlay */
.cam-overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
  display: flex;
  align-items: center;
  justify-content: center;
}
.vin-frame {
  width: 80%;
  height: 40%;
  border: 2px solid var(--lime);
  border-radius: 6px;
  box-shadow: 0 0 0 2000px rgba(0,0,0,0.45);
  position: relative;
}
.vin-frame::before {
  content: 'ALIGN VIN BARCODE / NUMBER HERE';
  position: absolute;
  top: -24px;
  left: 50%;
  transform: translateX(-50%);
  font-family: var(--font-display);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  color: var(--lime);
  white-space: nowrap;
}
/* Corner marks */
.vin-frame::after {
  content: '';
  position: absolute;
  inset: -2px;
  border: 2px solid transparent;
  border-top-color: var(--lime);
  border-left-color: var(--lime);
  border-radius: 6px 0 0 0;
  width: 20px;
  height: 20px;
}
.scan-line {
  position: absolute;
  left: 2px;
  right: 2px;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--lime), transparent);
  animation: scanAnim 2s linear infinite;
  opacity: 0.8;
}
@keyframes scanAnim {
  0% { top: 5%; }
  100% { top: 90%; }
}

.cam-hint {
  font-size: 11px;
  color: var(--muted);
  text-align: center;
  margin-bottom: 14px;
  letter-spacing: 0.5px;
}

.cam-btn-row { display: flex; gap: 10px; }
.cam-btn {
  flex: 1;
  padding: 13px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 800;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all .15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.cam-btn.primary { background: var(--lime); color: #000; }
.cam-btn.primary:hover { background: #ccff00; transform: translateY(-1px); }
.cam-btn.secondary { background: var(--s3); color: var(--text); border: 1px solid var(--border); }
.cam-btn.secondary:hover { border-color: var(--lime); }
.cam-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* UPLOAD fallback */
.upload-area {
  border: 1.5px dashed var(--border);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color .2s;
  margin-bottom: 14px;
}
.upload-area:hover { border-color: var(--lime); }
.upload-area input { display: none; }
.upload-icon { font-size: 28px; margin-bottom: 6px; }
.upload-label { font-size: 12px; color: var(--muted); }
.upload-label b { color: var(--text); }

/* OCR STATUS */
.ocr-status {
  background: var(--s2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 14px;
  display: none;
  align-items: center;
  gap: 12px;
}
.ocr-status.active { display: flex; }
.ocr-spinner {
  width: 18px;
  height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--lime);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }
.ocr-text { font-size: 13px; color: var(--muted); }
.ocr-text b { color: var(--lime); }
.ocr-progress { font-family: var(--font-mono); font-size: 11px; color: var(--lime); margin-left: auto; }

/* MANUAL PANEL */
.manual-panel { padding: 20px; display: none; }
.manual-panel.active { display: block; }

.field-group { margin-bottom: 16px; }
.field-label {
  font-family: var(--font-display);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 6px;
}
.vin-field {
  width: 100%;
  background: var(--s2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 18px;
  letter-spacing: 3px;
  padding: 12px 16px;
  text-transform: uppercase;
  outline: none;
  transition: border-color .2s;
}
.vin-field:focus { border-color: var(--lime); }
.vin-field::placeholder { color: var(--muted); letter-spacing: 1px; font-size: 13px; }

.vin-counter {
  font-size: 11px;
  color: var(--muted);
  text-align: right;
  margin-top: 4px;
  font-family: var(--font-mono);
}
.vin-counter.ready { color: var(--lime); }

.fields-row { display: grid; grid-template-columns: 1fr 1fr 100px; gap: 10px; }
.fields-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.num-field {
  width: 100%;
  background: var(--s2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 14px;
  padding: 10px 14px;
  outline: none;
  transition: border-color .2s;
}
.num-field:focus { border-color: var(--lime); }

/* DETECTED VIN BANNER */
.vin-detected {
  background: rgba(184,240,0,0.08);
  border: 1px solid rgba(184,240,0,0.3);
  border-radius: 8px;
  padding: 10px 14px;
  margin-bottom: 14px;
  display: none;
  align-items: center;
  gap: 10px;
}
.vin-detected.show { display: flex; }
.vd-icon { font-size: 18px; }
.vd-label { font-size: 11px; color: var(--muted); }
.vd-vin { font-family: var(--font-mono); font-size: 14px; color: var(--lime); letter-spacing: 2px; }
.vd-clear { margin-left: auto; font-size: 11px; color: var(--muted); cursor: pointer; }
.vd-clear:hover { color: var(--red); }

/* ANALYZE BUTTON */
.analyze-btn {
  width: 100%;
  background: var(--lime);
  border: none;
  border-radius: 10px;
  color: #000;
  cursor: pointer;
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 15px;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
.analyze-btn:hover { background: #ccff00; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(184,240,0,0.2); }
.analyze-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

/* ERROR */
.err-bar {
  background: rgba(240,60,48,0.1);
  border: 1px solid rgba(240,60,48,0.3);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--red);
  font-size: 13px;
  margin-bottom: 14px;
  display: none;
}
.err-bar.show { display: block; }

/* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
#results { animation: fadeUp .4s ease; }
@keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

/* HERO */
.hero {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr;
  gap: 2px;
  background: var(--border);
  border-radius: 14px;
  overflow: hidden;
  margin-bottom: 16px;
}
.hcell {
  background: var(--s1);
  padding: 22px 20px;
}
.hcell.main {
  background: linear-gradient(135deg, #0a1a02 0%, #0d2004 100%);
  border: 1px solid rgba(184,240,0,0.15);
}
.hc-l {
  font-family: var(--font-display);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
}
.hc-v {
  font-family: var(--font-display);
  font-size: 38px;
  font-weight: 800;
  line-height: 1;
  letter-spacing: -1px;
}
.hc-v.lime { color: var(--lime); }
.hc-v.dim { color: var(--dim); }
.hc-v.amber { color: var(--amber); }
.hc-s { font-size: 11px; color: var(--muted); margin-top: 6px; }
.hc-s b { color: var(--text); }
.save-pct {
  display: inline-block;
  background: rgba(184,240,0,0.12);
  border: 1px solid rgba(184,240,0,0.3);
  border-radius: 20px;
  color: var(--lime);
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 700;
  padding: 3px 10px;
  margin-top: 8px;
  letter-spacing: 0.5px;
}

/* VEHICLE STRIP */
.vstrip {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 18px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.vtitle {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 800;
  letter-spacing: 0.5px;
}
.vmeta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
.vchip {
  font-size: 10px;
  background: var(--s2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 8px;
  color: var(--muted);
}
.vchip b { color: #9aaa9a; }
.mkt-tag {
  font-family: var(--font-display);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  padding: 4px 12px;
  border-radius: 20px;
  white-space: nowrap;
  background: rgba(240,168,0,0.12);
  color: var(--amber);
  border: 1px solid rgba(240,168,0,0.25);
}

/* TABLE */
.tbl-wrap {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
}
table { width: 100%; border-collapse: collapse; }
thead tr { background: var(--s2); }
th {
  font-family: var(--font-display);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  padding: 10px 14px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th:nth-child(n+3) { text-align: right; }
td {
  padding: 11px 14px;
  border-bottom: 1px solid rgba(37,44,37,0.5);
  vertical-align: middle;
  font-size: 13px;
}
tr:last-child td { border-bottom: none; }
td:nth-child(n+3) { text-align: right; font-family: var(--font-mono); font-size: 12px; }

.row-pay td:first-child { border-left: 3px solid var(--safe); padding-left: 11px; }
.row-neg td:first-child { border-left: 3px solid var(--amber); padding-left: 11px; }
.row-ref td:first-child { border-left: 3px solid var(--red); padding-left: 11px; }
.row-fix td:first-child { border-left: 3px solid var(--blue); padding-left: 11px; }
.row-total td { background: rgba(184,240,0,0.05); font-weight: 600; }
.row-sticker td { color: var(--muted); }

.iname { font-weight: 600; color: var(--text); }
.inote { font-size: 11px; color: var(--muted); margin-top: 2px; }
.tag {
  display: inline-block;
  font-family: var(--font-display);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1px;
  padding: 2px 8px;
  border-radius: 3px;
}
.t-pay  { background: rgba(64,216,120,0.15); color: var(--safe); }
.t-neg  { background: rgba(240,168,0,0.15);  color: var(--amber); }
.t-ref  { background: rgba(240,60,48,0.15);  color: var(--red); }
.t-fix  { background: rgba(72,184,240,0.15); color: var(--blue); }
.t-tot  { background: rgba(184,240,0,0.15);  color: var(--lime); }

.strike { text-decoration: line-through; color: var(--muted); }
.lime   { color: var(--lime); }
.amber  { color: var(--amber); }
.red    { color: var(--red); }

/* PLAYBOOK */
.play {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 18px;
  margin-bottom: 16px;
}
.play-hdr {
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 800;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 14px;
}
.steps { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.step { display: flex; gap: 10px; align-items: flex-start; }
.sn {
  background: var(--lime);
  color: #000;
  font-family: var(--font-display);
  font-size: 10px;
  font-weight: 800;
  width: 20px; height: 20px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  margin-top: 1px;
}
.st { font-size: 12px; color: #8a9a8a; line-height: 1.55; }
.st b { color: var(--text); }
.st .m { color: var(--lime); font-family: var(--font-mono); font-size: 11px; }

.foot { font-size: 10px; color: var(--dim); margin-top: 14px; padding-top: 10px; border-top: 1px solid var(--border); }

/* MOBILE RESPONSIVE */
@media (max-width: 580px) {
  .hero { grid-template-columns: 1fr 1fr; }
  .hcell.main { grid-column: 1 / -1; }
  .hc-v { font-size: 30px; }
  .fields-row { grid-template-columns: 1fr 1fr; }
  .steps { grid-template-columns: 1fr; }
  .vstrip { flex-direction: column; align-items: flex-start; }
  th:nth-child(4) { display: none; }
  td:nth-child(4) { display: none; }
}
@media (max-width: 400px) {
  .fields-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="topbar">
  <div>
    <div class="logo">
      <span class="gc">GutCheck</span>
      <span class="sep">|</span>
      <span class="otd">TrueOTD</span>
    </div>
    <div class="logo-tag">Conflict-Free Car Price Intelligence</div>
  </div>
  <div class="mode-pill lot" id="lotPill">üìç On-Lot Mode</div>
</div>

<div class="wrap">

  <!-- INPUT CARD -->
  <div class="input-card">
    <div class="mode-tabs">
      <div class="mtab active" id="tabCam" onclick="switchTab('cam')">
        <span class="mtab-icon">üì∑</span> Scan VIN
      </div>
      <div class="mtab" id="tabManual" onclick="switchTab('manual')">
        <span class="mtab-icon">‚å®Ô∏è</span> Enter VIN
      </div>
    </div>

    <!-- CAMERA PANEL -->
    <div class="camera-panel active" id="camPanel">
      <div class="cam-area" id="camArea">
        <video id="cameraFeed" autoplay playsinline muted></video>
        <canvas id="previewCanvas"></canvas>
        <div class="cam-overlay" id="camOverlay">
          <div class="vin-frame">
            <div class="scan-line"></div>
          </div>
        </div>
        <div id="camPlaceholder" style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:8px;color:var(--muted);font-size:12px;text-align:center;padding:16px">
          <div style="font-size:32px">üì∑</div>
          <div>Tap <b style="color:var(--text)">Start Camera</b> to scan VIN on the lot</div>
          <div>or upload a photo below</div>
        </div>
      </div>

      <div class="cam-hint">Point camera at the VIN plate (dashboard, door jamb, or sticker) or upload a photo</div>

      <div class="ocr-status" id="ocrStatus">
        <div class="ocr-spinner"></div>
        <div class="ocr-text" id="ocrText">Reading VIN‚Ä¶</div>
        <div class="ocr-progress" id="ocrProg"></div>
      </div>

      <div class="vin-detected" id="vinDetected">
        <div class="vd-icon">‚úÖ</div>
        <div>
          <div class="vd-label">VIN Detected</div>
          <div class="vd-vin" id="detectedVin"></div>
        </div>
        <div class="vd-clear" onclick="clearDetected()">‚úï Clear</div>
      </div>

      <div class="cam-btn-row">
        <button class="cam-btn primary" id="startCamBtn" onclick="startCamera()">
          <span>‚ñ∂</span> Start Camera
        </button>
        <button class="cam-btn primary" id="captureBtn" onclick="captureFrame()" style="display:none">
          <span>‚äô</span> Capture VIN
        </button>
        <label class="cam-btn secondary" style="cursor:pointer">
          <span>üìÅ</span> Upload Photo
          <input type="file" accept="image/*" id="photoUpload" onchange="handleUpload(event)" style="display:none">
        </label>
        <button class="cam-btn secondary" id="retakeBtn" onclick="retakePhoto()" style="display:none">
          <span>‚Ü∫</span> Retake
        </button>
      </div>

      <!-- STICKER DETAILS IN CAM MODE -->
      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">
        <div class="field-label">Sticker Details (from photo or enter)</div>
        <div class="fields-row" style="margin-bottom:10px">
          <div class="field-group" style="margin:0">
            <div class="field-label">Base MSRP ($)</div>
            <input type="number" class="num-field" id="msrpCam" placeholder="e.g. 84435">
          </div>
          <div class="field-group" style="margin:0">
            <div class="field-label">Doc / Processing Fee ($)</div>
            <input type="number" class="num-field" id="docCam" placeholder="e.g. 2095">
          </div>
          <div class="field-group" style="margin:0">
            <div class="field-label">State</div>
            <input type="text" class="num-field" id="stateCam" placeholder="FL" maxlength="2" style="text-transform:uppercase">
          </div>
        </div>
      </div>
    </div>

    <!-- MANUAL PANEL -->
    <div class="manual-panel" id="manualPanel">
      <div class="field-group">
        <div class="field-label">Vehicle Identification Number (VIN)</div>
        <input type="text" class="vin-field" id="vinManual" maxlength="17"
          placeholder="Enter 17-character VIN"
          oninput="onVinType(this)">
        <div class="vin-counter" id="vinCounter">0 / 17</div>
      </div>
      <div class="fields-row">
        <div class="field-group" style="margin:0">
          <div class="field-label">Base MSRP ($)</div>
          <input type="number" class="num-field" id="msrpManual" placeholder="e.g. 84435">
        </div>
        <div class="field-group" style="margin:0">
          <div class="field-label">Doc / Processing Fee ($)</div>
          <input type="number" class="num-field" id="docManual" placeholder="e.g. 2095">
        </div>
        <div class="field-group" style="margin:0">
          <div class="field-label">State</div>
          <input type="text" class="num-field" id="stateManual" placeholder="FL" maxlength="2" style="text-transform:uppercase">
        </div>
      </div>
      <div style="margin-top:14px">
        <div class="field-label" style="margin-bottom:8px">Dealer Add-Ons (from sticker)</div>
        <div id="addonRows"></div>
        <button onclick="addRow()" style="background:none;border:1px dashed var(--border);border-radius:6px;color:var(--muted);cursor:pointer;font-size:12px;padding:7px 14px;margin-top:4px;font-family:var(--font-body);transition:all .15s" onmouseover="this.style.borderColor='var(--lime)';this.style.color='var(--lime)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">+ Add dealer option</button>
      </div>
    </div>

    <!-- SHARED BOTTOM -->
    <div style="padding:0 20px 20px">
      <div class="err-bar" id="errBar"></div>
      <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">
        <span>‚ö°</span> Get My TrueOTD Price
      </button>
    </div>
  </div>

  <div id="results"></div>
</div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TAX={AL:.04,AK:0,AZ:.056,AR:.065,CA:.0725,CO:.029,CT:.0635,DE:0,FL:.06,GA:.04,HI:.04,ID:.06,IL:.0625,IN:.07,IA:.06,KS:.065,KY:.06,LA:.0445,ME:.055,MD:.06,MA:.0625,MI:.06,MN:.06875,MS:.07,MO:.04225,MT:0,NE:.055,NV:.0685,NH:0,NJ:.06625,NM:.05125,NY:.04,NC:.03,ND:.05,OH:.0575,OK:.045,OR:0,PA:.06,RI:.07,SC:.06,SD:.045,TN:.07,TX:.0625,UT:.0485,VT:.06,VA:.043,WA:.065,WV:.06,WI:.05,WY:.04,DC:.06};
const REG={FL:225,PA:130,TX:150,CA:200,NY:180,OH:100,GA:120,NC:100,VA:140,NJ:150,TN:110,SC:100};

const ADDON_INTEL={
  'trd front skid plate':        {cat:'neg',disc:50,note:'OEM part ~$280 wholesale'},
  'toyoguard':                   {cat:'neg',disc:55,note:'SET bundle ¬∑ real value ~$300'},
  'ambient lighting':            {cat:'neg',disc:45,note:'Dealer-installed ¬∑ target $300'},
  'dashcam':                     {cat:'ref',disc:100,note:'Buy on Amazon for $60‚Äì$120'},
  'cargo cross bar':             {cat:'neg',disc:40,note:'Marked up 3√ó'},
  'console safe':                {cat:'ref',disc:100,note:'Online cost ~$60'},
  'screen protector':            {cat:'ref',disc:100,note:'Dealer cost <$5'},
  'multimedia screen protector': {cat:'ref',disc:100,note:'Dealer cost <$5'},
  'emergency':                   {cat:'ref',disc:100,note:'Amazon ~$25'},
  'phone cable':                 {cat:'ref',disc:100,note:'USB cables ¬∑ cost <$5'},
  'cable charge':                {cat:'ref',disc:100,note:'USB cables ¬∑ cost <$5'},
  'nitrogen':                    {cat:'ref',disc:100,note:'Free air works the same'},
  'vin etching':                 {cat:'ref',disc:100,note:'Insurance benefit is minimal'},
  'paint protection':            {cat:'neg',disc:60,note:'Can DIY for $40'},
  'fabric protection':           {cat:'ref',disc:100,note:'Scotchguard spray = $10'},
  'lo-jack':                     {cat:'neg',disc:50,note:'Subscription model ‚Äî negotiate hard'},
};

const DEFAULT_ADDONS=[
  {name:'TRD Front Skid Plate',     price:699},
  {name:'TOYOGUARD Platinum',       price:699},
  {name:'Ambient Lighting (LS100)', price:559},
  {name:'Dashcam (DC200)',          price:529},
  {name:'Cargo Cross Bars',         price:459},
  {name:'Center Console Safe',      price:399},
  {name:'Screen Protector (PR100)', price:129},
  {name:'Emergency Kit (EK100)',    price:89},
  {name:'Phone Cable Package',      price:79},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let stream = null;
let activeTab = 'cam';
let detectedVIN = '';
let addonCount = 0;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  DEFAULT_ADDONS.forEach(a => addRow(a.name, a.price));
  document.getElementById('msrpManual').value = 84435;
  document.getElementById('docManual').value = 2095;
  document.getElementById('stateManual').value = 'FL';
  document.getElementById('msrpCam').value = 84435;
  document.getElementById('docCam').value = 2095;
  document.getElementById('stateCam').value = 'FL';
});

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  activeTab = tab;
  document.getElementById('tabCam').classList.toggle('active', tab === 'cam');
  document.getElementById('tabManual').classList.toggle('active', tab === 'manual');
  document.getElementById('camPanel').classList.toggle('active', tab === 'cam');
  document.getElementById('manualPanel').classList.toggle('active', tab === 'manual');
  if (tab !== 'cam') stopCamera();
}

// ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    const feed = document.getElementById('cameraFeed');
    feed.srcObject = stream;
    feed.style.display = 'block';
    document.getElementById('camPlaceholder').style.display = 'none';
    document.getElementById('camOverlay').style.display = 'flex';
    document.getElementById('startCamBtn').style.display = 'none';
    document.getElementById('captureBtn').style.display = 'flex';
    document.getElementById('lotPill').textContent = 'üü¢ Camera Live';
  } catch(e) {
    showErr('Camera not available. Please upload a photo instead.');
  }
}

function stopCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  document.getElementById('cameraFeed').style.display = 'none';
  document.getElementById('camPlaceholder').style.display = 'flex';
  document.getElementById('camOverlay').style.display = 'none';
  document.getElementById('startCamBtn').style.display = 'flex';
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'none';
  document.getElementById('lotPill').textContent = 'üìç On-Lot Mode';
}

function captureFrame() {
  const feed = document.getElementById('cameraFeed');
  const canvas = document.getElementById('previewCanvas');
  canvas.width = feed.videoWidth;
  canvas.height = feed.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(feed, 0, 0);
  canvas.style.display = 'block';
  feed.style.display = 'none';
  stopCamera();
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'flex';
  document.getElementById('camOverlay').style.display = 'none';
  runOCR(canvas);
}

function retakePhoto() {
  document.getElementById('previewCanvas').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'none';
  document.getElementById('startCamBtn').style.display = 'flex';
  document.getElementById('vinDetected').classList.remove('show');
  document.getElementById('ocrStatus').classList.remove('active');
  detectedVIN = '';
}

function handleUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.onload = () => {
    const canvas = document.getElementById('previewCanvas');
    canvas.width = img.width;
    canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);
    canvas.style.display = 'block';
    document.getElementById('cameraFeed').style.display = 'none';
    document.getElementById('camPlaceholder').style.display = 'none';
    document.getElementById('camOverlay').style.display = 'none';
    document.getElementById('startCamBtn').style.display = 'none';
    document.getElementById('captureBtn').style.display = 'none';
    document.getElementById('retakeBtn').style.display = 'flex';
    runOCR(canvas);
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

async function runOCR(canvas) {
  const status = document.getElementById('ocrStatus');
  const ocrText = document.getElementById('ocrText');
  const ocrProg = document.getElementById('ocrProg');
  status.classList.add('active');
  ocrText.innerHTML = 'Reading VIN from image‚Ä¶';
  ocrProg.textContent = '0%';

  try {
    const result = await Tesseract.recognize(canvas, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          ocrProg.textContent = Math.round(m.progress * 100) + '%';
        }
      },
      tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
    });

    const raw = result.data.text.replace(/[^A-HJ-NPR-Z0-9]/gi, '').toUpperCase();
    // Find a 17-char VIN-like sequence
    const vinMatch = raw.match(/[A-HJ-NPR-Z0-9]{17}/);

    status.classList.remove('active');

    if (vinMatch) {
      detectedVIN = vinMatch[0];
      document.getElementById('detectedVin').textContent = detectedVIN;
      document.getElementById('vinDetected').classList.add('show');
      ocrText.innerHTML = `<b style="color:var(--lime)">VIN found: ${detectedVIN}</b>`;
    } else {
      ocrText.innerHTML = 'Could not extract VIN automatically ‚Äî enter manually below.';
      status.classList.add('active');
      setTimeout(() => status.classList.remove('active'), 3500);
    }
  } catch(e) {
    status.classList.remove('active');
    showErr('OCR failed. Please enter VIN manually.');
  }
}

function clearDetected() {
  detectedVIN = '';
  document.getElementById('vinDetected').classList.remove('show');
}

// ‚îÄ‚îÄ MANUAL VIN TYPING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onVinType(el) {
  el.value = el.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
  const len = el.value.length;
  const counter = document.getElementById('vinCounter');
  counter.textContent = `${len} / 17`;
  counter.classList.toggle('ready', len === 17);
}

// ‚îÄ‚îÄ ADD-ON ROWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addRow(name='', price='') {
  addonCount++;
  const id = addonCount;
  const row = document.createElement('div');
  row.id = `addon-${id}`;
  row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px;align-items:center';
  row.innerHTML = `
    <input type="text" class="num-field addon-name" placeholder="Option name (e.g. Dashcam)" value="${name}"
      style="flex:1;font-size:13px;letter-spacing:0;padding:8px 12px">
    <input type="number" class="num-field addon-price" placeholder="$" value="${price}"
      style="width:100px;font-size:13px;padding:8px 12px">
    <button onclick="document.getElementById('addon-${id}').remove()"
      style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;width:32px;height:32px;flex-shrink:0;font-size:14px;transition:all .15s"
      onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'"
      onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">√ó</button>`;
  document.getElementById('addonRows').appendChild(row);
}

// ‚îÄ‚îÄ CLASSIFY ADDONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function classify(name, price) {
  const low = name.toLowerCase();
  for (const [key, info] of Object.entries(ADDON_INTEL)) {
    if (low.includes(key)) return { ...info };
  }
  return { cat: 'neg', disc: 35, note: 'Regional dealer option. Typical 2‚Äì3√ó markup.' };
}

// ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analyze() {
  hideErr();
  let vin, msrp, doc, state;

  if (activeTab === 'cam') {
    vin = detectedVIN || '';
    msrp = parseFloat(document.getElementById('msrpCam').value) || 0;
    doc  = parseFloat(document.getElementById('docCam').value)  || 0;
    state = (document.getElementById('stateCam').value || 'FL').toUpperCase();
    if (vin.length !== 17) { showErr('No VIN detected yet. Scan a photo or switch to Enter VIN tab.'); return; }
  } else {
    vin   = document.getElementById('vinManual').value.trim().toUpperCase();
    msrp  = parseFloat(document.getElementById('msrpManual').value) || 0;
    doc   = parseFloat(document.getElementById('docManual').value)  || 0;
    state = (document.getElementById('stateManual').value || 'FL').toUpperCase();
    if (vin.length !== 17) { showErr('Enter all 17 characters of the VIN.'); return; }
  }

  // Collect addons (always from manual panel rows)
  const addons = [];
  document.querySelectorAll('#addonRows > div').forEach(row => {
    const n = row.querySelector('.addon-name')?.value?.trim();
    const p = parseFloat(row.querySelector('.addon-price')?.value) || 0;
    if (n && p > 0) addons.push({ name: n, price: p, ...classify(n, p) });
  });

  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true; btn.innerHTML = '<span class="ocr-spinner" style="border-top-color:#000;width:16px;height:16px;margin:0 8px"></span> Decoding VIN‚Ä¶';

  let vehicle = null;
  try {
    const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
    const d = await r.json();
    if (d.Results) vehicle = d.Results[0];
  } catch(e) {}

  btn.disabled = false; btn.innerHTML = '<span>‚ö°</span> Get My TrueOTD Price';
  render(vehicle, msrp, doc, state, addons);
}

// ‚îÄ‚îÄ RENDER RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(v, msrp, doc, state, addons) {
  const tax  = TAX[state] ?? 0.06;
  const reg  = REG[state] ?? 175;
  const docT = doc * 0.50;

  const refItems = addons.filter(a => a.cat === 'ref');
  const negItems = addons.filter(a => a.cat === 'neg');
  const refTotal = refItems.reduce((s,a)=>s+a.price, 0);
  const negTotal = negItems.reduce((s,a)=>s+a.price, 0);
  const negSavings = negItems.reduce((s,a)=>s + a.price*(a.disc/100), 0);

  const stickerBase = msrp + addons.reduce((s,a)=>s+a.price,0) + doc;
  const stickerOTD  = stickerBase + stickerBase*tax + reg;

  const gcAddons = negTotal - negSavings;
  const gcBase   = msrp + gcAddons + docT;
  const gcOTD    = gcBase + gcBase*tax + reg;
  const savings  = stickerOTD - gcOTD;
  const savPct   = (savings/stickerOTD*100).toFixed(1);

  const f = n => '$' + Math.round(n).toLocaleString();
  const yr    = v?.ModelYear || '‚Äî';
  const make  = v?.Make      || '‚Äî';
  const model = v?.Model     || '‚Äî';
  const trim  = v?.Trim || v?.Series || '';
  const eng   = v?.DisplacementL ? `${v.DisplacementL}L ${v.FuelTypePrimary||''}` : (v?.FuelTypePrimary||'‚Äî');
  const drive = v?.DriveType  || '‚Äî';
  const plant = v?.PlantCity  ? `${v.PlantCity}, ${v.PlantState}` : '‚Äî';
  const vinNum = v?.VIN || document.getElementById(activeTab==='cam'?'':' vinManual')?.value || '‚Äî';

  let html = '';

  // HERO
  html += `<div class="hero">
    <div class="hcell main">
      <div class="hc-l">TrueOTD Target ‚Äî All In</div>
      <div class="hc-v lime">${f(gcOTD)}</div>
      <div class="hc-s">Tax ¬∑ tags ¬∑ ${state} ¬∑ fully negotiated</div>
      <div class="save-pct">Save up to ${f(savings)} ¬∑ ${savPct}% off sticker</div>
    </div>
    <div class="hcell">
      <div class="hc-l">Sticker OTD</div>
      <div class="hc-v dim">${f(stickerOTD)}</div>
      <div class="hc-s">If you sign without negotiating</div>
    </div>
    <div class="hcell">
      <div class="hc-l">Negotiable Exposure</div>
      <div class="hc-v amber">${f(savings)}</div>
      <div class="hc-s"><b>${savPct}%</b> retrievable savings</div>
    </div>
  </div>`;

  // VEHICLE STRIP
  if (v && v.Make) {
    html += `<div class="vstrip">
      <div>
        <div class="vtitle">${yr} ${make} ${model}${trim?' ¬∑ '+trim:''}</div>
        <div class="vmeta">
          <div class="vchip"><b>VIN</b> ${v.VIN||'‚Äî'}</div>
          <div class="vchip"><b>Engine</b> ${eng}</div>
          <div class="vchip"><b>Drive</b> ${drive}</div>
          <div class="vchip"><b>Built</b> ${plant}</div>
        </div>
      </div>
      <div class="mkt-tag">‚ö† Regional Distributor Add-Ons Detected</div>
    </div>`;
  }

  // TABLE
  html += `<div class="tbl-wrap"><table>
    <thead><tr><th>Item</th><th>Action</th><th>Sticker</th><th>Target</th><th>Save</th></tr></thead>
    <tbody>`;

  // Pay
  html += `<tr class="row-pay">
    <td><div class="iname">Base MSRP</div><div class="inote">Factory price ¬∑ non-negotiable in current market</div></td>
    <td><span class="tag t-pay">PAY</span></td>
    <td>${f(msrp)}</td><td class="lime">${f(msrp)}</td><td>‚Äî</td></tr>`;

  // Negotiate
  negItems.forEach(a => {
    const t = Math.round(a.price*(1-a.disc/100));
    html += `<tr class="row-neg">
      <td><div class="iname">${a.name}</div><div class="inote">${a.note}</div></td>
      <td><span class="tag t-neg">NEGOTIATE</span></td>
      <td class="strike">${f(a.price)}</td>
      <td class="amber">${f(t)}</td>
      <td class="amber">‚àí${a.disc}%</td></tr>`;
  });

  // Doc fee
  html += `<tr class="row-neg">
    <td><div class="iname">Doc / Processing Fee</div><div class="inote">${state} avg $699‚Äì$999 ¬∑ this fee is not legally mandated</div></td>
    <td><span class="tag t-neg">NEGOTIATE</span></td>
    <td class="strike">${f(doc)}</td><td class="amber">${f(docT)}</td><td class="amber">‚àí50%</td></tr>`;

  // Refuse
  refItems.forEach(a => {
    html += `<tr class="row-ref">
      <td><div class="iname">${a.name}</div><div class="inote">${a.note}</div></td>
      <td><span class="tag t-ref">REFUSE</span></td>
      <td class="strike">${f(a.price)}</td>
      <td class="red">$0</td><td class="red">‚àí100%</td></tr>`;
  });

  // Fixed
  html += `<tr class="row-fix">
    <td><div class="iname">${state} Sales Tax (${(tax*100).toFixed(2)}%)</div><div class="inote">On negotiated base ¬∑ fixed by law ¬∑ lower base = less tax</div></td>
    <td><span class="tag t-fix">FIXED</span></td>
    <td>${f(stickerBase*tax)}</td><td class="lime">${f(gcBase*tax)}</td>
    <td class="lime">${f((stickerBase-gcBase)*tax)} less</td></tr>
  <tr class="row-fix">
    <td><div class="iname">${state} Reg / Title / Tags (est.)</div><div class="inote">State DMV ‚Äî cannot be negotiated</div></td>
    <td><span class="tag t-fix">FIXED</span></td>
    <td>${f(reg)}</td><td>${f(reg)}</td><td>‚Äî</td></tr>`;

  // Totals
  html += `<tr class="row-sticker">
    <td colspan="2"><div class="iname">Sticker OTD (no negotiation)</div></td>
    <td colspan="2" class="strike">${f(stickerOTD)}</td><td></td></tr>
  <tr class="row-total">
    <td colspan="2"><div class="iname lime" style="font-size:14px">‚úì GutCheck TrueOTD Target</div></td>
    <td colspan="2" class="lime" style="font-size:16px;font-weight:700">${f(gcOTD)}</td>
    <td class="lime">${f(savings)} saved</td></tr>
  </tbody></table></div>`;

  // PLAYBOOK
  html += `<div class="play">
    <div class="play-hdr">Negotiation Playbook</div>
    <div class="steps">
      <div class="step"><div class="sn">1</div><div class="st"><b>Lead with TrueOTD.</b> "My number is <span class="m">${f(gcOTD)}</span> all-in. Can you do that today?"</div></div>
      <div class="step"><div class="sn">2</div><div class="st"><b>Refuse junk immediately.</b> Screen protectors, cables, emergency kits ‚Äî "Remove these. $0."</div></div>
      <div class="step"><div class="sn">3</div><div class="st"><b>Challenge TOYOGUARD/bundles.</b> "What did you pay for this?" Offer <span class="m">$300</span> max or cut it.</div></div>
      <div class="step"><div class="sn">4</div><div class="st"><b>Doc fee.</b> "${state} avg is under $1,000. I'll accept <span class="m">${f(docT)}</span> ‚Äî not a cent more."</div></div>
      <div class="step"><div class="sn">5</div><div class="st"><b>Get competing quotes.</b> Other dealers within 90 min. A phone call costs nothing.</div></div>
      <div class="step"><div class="sn">6</div><div class="st"><b>Walk if needed.</b> Stand up, leave your number. End-of-month = 60% chance of a callback.</div></div>
    </div>
    <div class="foot">GutCheck TrueOTD ¬∑ VIN via NHTSA vPIC API ¬∑ ${state} tax ${(tax*100).toFixed(2)}% ¬∑ Reg est. ${f(reg)} ¬∑ Reference only, not legal advice.</div>
  </div>`;

  const el = document.getElementById('results');
  el.innerHTML = html;
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showErr(msg) {
  const e = document.getElementById('errBar');
  e.textContent = msg; e.classList.add('show');
}
function hideErr() { document.getElementById('errBar').classList.remove('show'); }
</script>
</body>
</html>
